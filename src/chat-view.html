<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-behavior.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="utility.html">

<dom-module id="chat-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      .business-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
      }

      .business-name {
        padding: 10px;
      }

      iron-icon {
        color: white;
        background: #FFA138;
      }

      #image-btn {
        background: #FFA138;
      }

      .flex-horizontal {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-end-justified;
      }

      #message {
        --paper-input-container-focus-color: #70C187;
      }

      .message-container-main {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .message-sender-container {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-around-justified;
        background: white;
        border-radius: 5px;
        max-width: 400px;
        margin: auto;
        position: sticky;
        position: -webkit-sticky;
        bottom: 0px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      }

      .profile-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
      }

      #send-btn {
        background-color: #70C187;
        color: white; 
      }

      .title {
        @apply --layout-horizontal;
        @apply --layout-center-justified; 
        @apply --layout-center;
        background-color: white; 
        box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        margin-bottom: 5px;
        border-radius: 5px;

      }

      .username {
        padding: 10px;
      }


    </style>

    <firebase-auth 
      id="auth"
      app-name="polyn-app"
      user="{{user}}">
    </firebase-auth>

    <firebase-document
      app-name="polyn-app"
      id="usersinfo"
      data="{{usersInfo}}">
    </firebase-document>

    <firebase-document
      app-name="polyn-app"
      id="chatinfo"
      path="/users/[[user.uid]]/requests/[[requestId]]"
      data="{{chatInfo}}">
    </firebase-document>

    <firebase-document
      app-name="polyn-app"
      id="otherusersinfo"
      data="{{otherUsersInfo}}">
    </firebase-document>

    <firebase-messaging
      id="messaging"
      app-name="polyn-app"
      token="{{token}}">
    </firebase-messaging>

    <firebase-document
      app-name="polyn-app"
      path="/users/[[user.uid]]/info/token"
      data="[[token]]">
    </firebase-document>

    <app-indexeddb-mirror 
      session="[[user.uid]]" 
      key="chats/[[chatMessagesId]]" 
      data="{{chatMessages}}" 
      persisted-data="{{persistedChatMessages}}">
    </app-indexeddb-mirror>

    <iron-ajax
      id="sendMessage"
      url="https://us-central1-polyn-3c431.cloudfunctions.net/sendMessage"
      method="POST"
      loading="{{loading}}"
      on-response="_handleSendMessageResponse"
      on-error="_handleSendMessageError"
      debounce-duration="300">
    </iron-ajax>

    <paper-spinner id="spinner" active="[[loading]]" active></paper-spinner>


    <div class="title">
      <div class="business-photo">
        <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="profile-pic" preload fade src="images/RecordStoreDayLogo.jpg" class="item" on-tap="_onTapBusiness" ></iron-image>
      </div>
      <div class="business-name">
        Conversation between you and @Seller 
        <p style="margin: 0px;">www.recordStoreWebsite.com</p>
      </div>
    </div>

    <div class="content-wrapper">
     
    <dom-repeat items="[[persistedChatMessages]]" as="chatMessage">
      <template>
       <div class="message-container-main"> 
        <div class="card">

          <template is="dom-if" if="[[chatMessage.text]]">
            <p>[[chatMessage.text]]</p>
          </template>

          <template is="dom-if" if="[[chatMessage.photoUrl]]">
            <iron-image src="[[chatMessage.photoUrl]]"></iron-image> 
          </template>

            <div class="flex-horizontal">
              <div class="user-photo">
                <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="business-pic" preload fade src="images/anonymous_profile.png" class="item" on-tap="_onTapBusiness" ></iron-image> 
              </div>
              <div class="username">
                [[chatMessage.name]]
              </div>           
            </div>
          </div>
      </template>
    </dom-repeat>
    </div>
  
  
    <div class="message-sender-container anchor">
      <paper-input id="message" label="Message..."></paper-input>
      <paper-button id="image-btn" on-tap="_onTapImageBtn" dialog-confirm autofocus raised type="submit"><iron-icon icon="custom-icons:insert-photo"></iron-icon></paper-button>
      <paper-button id="send-btn" on-tap="_onTapSendDialogBtn" dialog-confirm autofocus raised type="submit">Send</paper-button>
    </div>

    <input id="camera" type="file" name="photo" accept="image/*;capture=camera" style="display:none;"></input>
      
  </template>

  <script>
    class ChatView extends Polymer.Element {

      static get is() { return 'chat-view'; }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: '_userChanged'
          },
          usersInfo: {
            type: Object,
            observer: '_usersInfoChanged'
          },
          otherUsersInfo: {
            type: Object,
            observer: '_otherUsersInfoChanged'
          },
          requestId: {
            type: String
          },
          chatInfo: {
            type: Object,
            observer: '_chatInfoChanged'
          },
          chatMessagesId: {
            type: String,
            observer: '_chatMessagesIdChanged'
          },
          chatMessages: {
            type: Array,
            value: []
          },
          loading: {
            type: Boolean,
            notify: true,
            value: false
          },
          chatPhotoUrl: {
            type: String,
            value: null
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("ChatView.connectedCallback")

        var self = this;
        var camera = this.$.camera;

        // Use the hidden input called 'camera' to get a photo from the user 
        // if they tap the image button!
        camera.addEventListener('change', function(e) {

          var file = e.target.files[0];

          if(!file) {
            return;
          }

          if(!file.type.match('image.*')) {
            Utility.showErrorToast("You can only share images.");
            return;
          }

          Utility.correctOrientation(file, function(blob, error) {
            if(!error) {

// TODO: How should we preview the image so the user can see it before sending it?

              self._uploadChatPhoto(blob);
            } else {
              Utility.showErrorToast("Sorry, but we were unable to use this image for some reason.");
            }
          });
        });
      }

      _uploadChatPhoto(file) {
        console.log("ChatView._uploadChatPhoto");

        var self = this;

        // Upload the image to Cloud Storage.
        var newImageKey = firebase.app("polyn-app").database().ref().child("users/" + self.user.uid + "/chatphotos").push().key;

        firebase.app("polyn-app").storage().ref("users/" + self.user.uid + "/chatphotos" + "/" + newImageKey).put(file).then(function(snapshot) {
          //console.log("snapshot.downloadURL = " + snapshot.downloadURL);
          self.chatPhotoUrl = snapshot.downloadURL;
          self._sendChatMessage();
        });
      }

      _chatMessagesIdChanged(chatMessagesId) {
        console.log("ChatView._chatMessagesIdChanged: " + chatMessagesId);

        if(chatMessagesId) {

          var self = this;

          var setMessage = function(snapshot) {
            var val = snapshot.val();
            self.push('chatMessages', val);
          };

          firebase.app("polyn-app").database().ref("/chats/" + chatMessagesId).on('child_added', setMessage);
        }
      }

      _userChanged(user) {
        console.log("ChatView._userChanged");

        // As soon as we get the user - get the users info so we can 
        // learn more about them!
        if(user && user.uid) {
          this.$.usersinfo.path = "/users/" + user.uid + "/info";
        }
      }

      _usersInfoChanged(usersInfo) {
        console.log("ChatView._usersInfoChanged");

// TODO: Is this the best way to check for an empty JSON object?
        if(!usersInfo || Object.keys(usersInfo).length === 0 && usersInfo.constructor === Object) {
          return;
        }

        // If the user has no token - we should prompt for permisssion!
        if(!usersInfo.token) {
          this._requestNotificationPermission();
        }
      }

      _chatInfoChanged(e) {
        console.log("ChatView._chatInfoChanged: " + JSON.stringify(e, null, 4));

        if(!this.user || !this.chatInfo) {
          return;
        }

        // As soon as we get the user and the chat info - get the other 
        // users info so we know who we're chatting with.
        var otherUsersId;

        if(this.user.uid == this.chatInfo.buyerId) {
          otherUsersId = this.chatInfo.sellerId; // The other user is the seller.
        } else {
          otherUsersId = this.chatInfo.buyerId; // The other user is the buyer.
        }

        if(otherUsersId) {
          this.$.otherusersinfo.path = "/users/" + otherUsersId + "/info";
        }
      }
      
      _otherUsersInfoChanged(otherUsersInfo) {
        console.log("ChatView._otherUsersInfoChanged: " + JSON.stringify(otherUsersInfo, null, 4));

      }

      _requestNotificationPermission() {
        console.log("ChatView._requestNotificationPermission");

        this.$.messaging.activate();
        this.$.messaging.requestPermission()
          .then(() => {
            console.log('Notification Message permission granted!');
          })
          .catch((err) => {
            console.log('Notification Message permission denied!');
          });
      }

      _onTapImageBtn() {
        console.log("ChatView._onTapImageBtn");
        this.$.camera.click();
      }

      _onTapSendDialogBtn() {
        console.log("ChatView._onTapSendDialogBtn: message = " + this.$.message.value);

        if(!this.$.message.value && !this.chatPhotoUrl) {
          return;
        }

        if(this.chatMessagesId) {
          this._sendChatMessage();
        } else {

          // We don't have a chatMessagesId yet so create it first and then send a message.
          var newChatMessageKey = firebase.app("polyn-app").database().ref().child("chats/").push().key;

          if(newChatMessageKey) {

            this.chatMessagesId = newChatMessageKey;

            // Save the chatMessagesId back to the chat entry.
            firebase.app("polyn-app").database().ref().child("/users/" + this.user.uid + "/requests/" + this.requestId + "/chatId").set(newChatMessageKey);

              // console.log("this.chatInfo.buyerId = " + this.chatInfo.buyerId);
              // console.log("this.chatInfo.requestId = " + this.chatInfo.requestId);

              var newOthersChatMessageKey = firebase.app("polyn-app").database().ref().child("/users/" + this.chatInfo.buyerId + "/requests/" + this.chatInfo.requestId + "/chats").push().key;
              if(newOthersChatMessageKey) {

                // console.log("chatId = " + newChatMessageKey);
                // console.log("seller = " + this.usersInfo.name);
                // console.log("sellerId = " + this.usersInfo.sellerId);

                let newChatEntry = {
                  chatId : newChatMessageKey,
                  seller : this.usersInfo.name,
                  sellerId: this.usersInfo.sellerId,
                  timeStamp: firebase.database.ServerValue.TIMESTAMP
                };

                firebase.app("polyn-app").database().ref().child("/users/" + this.chatInfo.buyerId + "/requests/" + this.chatInfo.requestId + "/chats/" + newOthersChatMessageKey).set(newChatEntry);
              }

            this._sendChatMessage();
          }
        }
      }

      _sendChatMessage() {
        console.log("ChatView._sendChatMessage");

        if(!this.$.message.value && !this.chatPhotoUrl) {
          return;
        }

        const text = this.$.message.value;
        const photoUrl = this.chatPhotoUrl;

        const newKey = firebase.app("polyn-app").database().ref().child("chats/" + this.chatMessagesId).push().key;

        var chatMessage = {
          name: this.usersInfo.name,
          senderId: this.user.uid,
          timeStamp: firebase.database.ServerValue.TIMESTAMP
        };

        if(text) {
          chatMessage.text = text;
        }

        if(photoUrl) {
          chatMessage.photoUrl = photoUrl;
        }

        // Write the new chat message under a new key, which is under the existing chat mnessage thread id.
        firebase.app("polyn-app").database().ref("chats/" + this.chatMessagesId + "/" + newKey).set(chatMessage);

        // Empty the message input.
        this.$.message.value = "";

        if(this.otherUsersInfo.token) {

          var params = {
            token: this.otherUsersInfo.token,
            title: this.usersInfo.name + " sent you a message.",
            body: text,
            icon: "/images/polyn-msg.png",
            click_action: "https://vinylrecords.io/"
          };

          console.log("  Sending message: " + JSON.stringify(params, null, 4));

          this.$.sendMessage.params = params;
          this.$.sendMessage.generateRequest();
        } else {
          console.log("  No token found for: " + this.otherUsersInfo.name);
        }
      }

      _handleSendMessageResponse(data) {
        console.log("ChatView._handleSendMessageResponse");
        console.log("  status = " + data.detail.status);
      }

      _handleSendMessageError(e) {
        console.log("ChatView._handleSendMessageError");
        console.log("  status = ", e.status, e.statusText);
      }
    }

    window.customElements.define(ChatView.is, ChatView);
  </script>
</dom-module>