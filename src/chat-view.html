<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-behavior.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="utility.html">

<dom-module id="chat-view">
  <template>
    <style include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: block;
        padding: 10px;
      }

      .bottom-border {
        border-bottom-style: solid;
        border-bottom-color: #70C187;
        border-bottom-width: .5px;
        padding-top: 15px;
        padding-bottom: 15px;
      }

      .business-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
      }

      .business-name {
        padding: 10px;
      }

      .card {
        max-width: 400px;
      }

      iron-icon {
        color: white;
      }

      iron-image {
        --iron-image-width: 100%;
      }

      #image-btn {
        color: white;
        background: #FFA138;
      }

      .flex-horizontal {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-end-justified;
      }

      #message {
        --paper-input-container-focus-color: #70C187;
      }

      .message-container-main {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .message-sender-container {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-around-justified;
        background: white;
        border-radius: 5px;
        max-width: 400px;
        margin: auto;
        position: sticky;
        position: -webkit-sticky;
        overflow-y: scroll;
        height: 100%;
        -webkit-overflow-scrolling: touch;
        bottom: 0px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
      }

      .overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0; 
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #FFF; 
        z-index: 999999;
      }

      .profile-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
      }

      paper-textarea {
        margin: 10px;
        width: 100%;
      }

      #send-btn {
        background-color: #70C187;
        color: white; 
      }

      .title {
        @apply --layout-horizontal;
        @apply --layout-center-justified; 
        @apply --layout-center;
        background-color: white; 
        box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        margin-bottom: 5px;
        border-radius: 5px;
      }

      .username {
        font-weight: bold;
      }

      .user-photo {
        padding-right: 15px;
      }

    </style>   

    <firebase-auth 
      id="auth"
      app-name="polyn-app"
      user="{{user}}">
    </firebase-auth>

    <firebase-document
      app-name="polyn-app"
      id="usersinfo"
      data="{{usersInfo}}">
    </firebase-document>

    <firebase-messaging
      id="messaging"
      app-name="polyn-app"
      token="{{token}}">
    </firebase-messaging>

    <firebase-document
      app-name="polyn-app"
      path="/users/[[user.uid]]/info/token"
      data="[[token]]">
    </firebase-document>

    <app-indexeddb-mirror
      session="[[user.uid]]"
      key="chats/[[chatMessagesId]]"
      data="{{chatMessages}}"
      persisted-data="{{persistedChatMessages}}">
    </app-indexeddb-mirror>

    <iron-ajax
      id="sendMessage"
      url="https://us-central1-polyn-3c431.cloudfunctions.net/sendMessage"
      method="POST"
      loading="{{loading}}"
      on-response="_handleSendMessageResponse"
      on-error="_handleSendMessageError"
      debounce-duration="300">
    </iron-ajax>

    <template is="dom-if" if="[[loading]]">
      <div class="overlay">
        <paper-spinner id="spinner" active="[[loading]]"></paper-spinner>
      </div>
    </template>

    <div class="title">
      <div class="business-photo">
        <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="profile-pic" preload fade src="images/RecordStoreDayLogo.jpg" class="item" on-tap="_onTapBusiness" ></iron-image>
      </div>
      <div class="business-name">
        Conversation between you and @Seller 
        <p style="margin: 0px;">www.recordStoreWebsite.com</p>
      </div>
    </div>

    <div class="card">
      
      <dom-repeat items="[[persistedChatMessages]]" as="chatMessage">
        <template>
          <div class="bottom-border">

            
            <template is="dom-if" if="[[chatMessage.photoUrl]]">
              <iron-image src="[[chatMessage.photoUrl]]"></iron-image> 
            </template>

              <div class="horizontal layout start">
                <div class="user-photo">
                  <template is="dom-if" if="[[chatMessage.photoThumbURL]]">
                    <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="business-pic" preload fade src="[[chatMessage.photoThumbURL]]" class="item"></iron-image> 
                  </template>
                  <template is="dom-if" if="[[!chatMessage.photoThumbURL]]">
                    <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="business-pic" preload fade src="images/anonymous_profile.png" class="item"></iron-image> 
                  </template>
                </div>

              <div class="flex vertical layout">
                <div class="username horizontal layout">
                  [[chatMessage.name]]
                </div> 
                  <template is="dom-if" if="[[chatMessage.text]]">
                <div class="horizontal layout center">
                  <p>[[chatMessage.text]]</p>
                </div>
              </div>
            </template>          
          </div>

          
        </template>
      </dom-repeat>
    </div>
    
  
    <div class="card">
      <div class="flex layout horizontal center-justified">
        <paper-textarea id="message" label="Message..."></paper-textarea>
      </div>
      <div class="flex layout horizontal right-justified">
        <paper-button id="image-btn" on-tap="_onTapImageBtn"  dialog-confirm autofocus raised type="submit"><iron-icon icon="custom-icons:insert-photo"></iron-icon></paper-button>
        <paper-button id="send-btn" on-tap="_onTapSendDialogBtn" class="flex" dialog-confirm autofocus raised type="submit"><iron-icon icon="custom-icons:send"></iron-icon></paper-button>
      </div>
    </div>
    
  </div>

    <input id="camera" type="file" name="photo" accept="image/*;capture=camera" style="display:none;"></input>
      
  </template>

  <script>
    class ChatView extends Polymer.Element {

      static get is() { return 'chat-view'; }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: '_userChanged'
          },
          usersInfo: {
            type: Object,
            observer: '_usersInfoChanged'
          },
          otherUsersInfo: {
            type: Object
          },
          requestId: {
            type: String
          },
          subChatId: {
            type: String
          },
          chatInfo: {
            type: Object
          },
          chatMessagesId: {
            type: String
          },
          chatMessages: {
            type: Array,
            value: []
          },
          loading: {
            type: Boolean,
            notify: true,
            value: true
          },
          chatPhotoUrl: {
            type: String,
            value: null
          }
        };
      }

      reload() {
        console.log("ChatView.reload");
        this._loadChatInfo();
      }

      poppedCallback() {
        console.log("ChatView.poppedCallback");

        // If we're getting popped off - reset these!
        this.requestId = null;
        this.subChatId = null;
        this.chatMessagesId = null;
        this.chatPhotoUrl = null;
        this.chatMessages = [];

        self.loading = true;
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("ChatView.connectedCallback")

        var self = this;
        var camera = this.$.camera;

        // Use the hidden input called 'camera' to get a photo from the user 
        // if they tap the image button!
        camera.addEventListener('change', function(e) {

          var file = e.target.files[0];

          if(!file) {
            return;
          }

          if(!file.type.match('image.*')) {
            Utility.showErrorToast("You can only share images.");
            return;
          }

          Utility.correctOrientation(file, function(blob, error) {
            if(!error) {

// TODO: How should we preview the image so the user can see it before sending it?

              self._uploadChatPhoto(blob);
            } else {
              Utility.showErrorToast("Sorry, but we were unable to use this image for some reason.");
            }
          });
        });
      }

      _loadChats() {

        if(this.chatMessagesId) {

          var self = this;

          self.loading = true;

          var setMessage = function(snapshot) {
            var val = snapshot.val();

            //console.log(" snapshot: " + JSON.stringify(snapshot, null, 4));

            if(self.user.uid == val.senderId) {
              if(self.usersInfo.photoThumbURL) {
                val.photoThumbURL = self.usersInfo.photoThumbURL;
              }
            } else {
              if(self.otherUsersInfo.photoThumbURL) {
                val.photoThumbURL = self.otherUsersInfo.photoThumbURL;
              }
            }

            self.push('chatMessages', val);

            self.chatMessages.sort(function(a, b){return a.timeStamp - b.timeStamp});

// TODO: Kevin fix this!!!!!
            //self.loading = false;
          };

          firebase.app("polyn-app").database().ref("/chats/" + this.chatMessagesId).on('child_added', setMessage);

          // No matter how fast it loads - show the spinner for at least 0.5 seconds.
          setTimeout(function() { self.loading = false; }, 500);
        } else {
          this.loading = false;

          // Create a fake message from the buyer so the seller has something to read.
          var fakedMessage = {
            name: this.otherUsersInfo.name,
            text: this.chatInfo.desc,
            senderId: this.chatInfo.buyerId,
            photoThumbURL: this.otherUsersInfo.photoThumbURL,
            timeStamp: firebase.database.ServerValue.TIMESTAMP
          };

          this.push('chatMessages', fakedMessage);
        }
      }

      _userChanged(user) {
        //console.log("ChatView._userChanged");
        console.log("ChatView._userChanged: " + JSON.stringify(user, null, 4));

        // As soon as we get the user - get the users info so we can 
        // learn more about them!
        if(user && user.uid) {
          this.$.usersinfo.path = "/users/" + user.uid + "/info";
        }
      }

      _usersInfoChanged(usersInfo) {
        //console.log("ChatView._usersInfoChanged");
        console.log("ChatView._usersInfoChanged: " + JSON.stringify(usersInfo, null, 4));

        if(!usersInfo || Object.keys(usersInfo).length === 0 && usersInfo.constructor === Object) {
          return;
        }

        // If the user has no token - we should prompt for permisssion!
        if(!usersInfo.token) {
          this._requestNotificationPermission();
        }

        this._loadChatInfo();
      }

      _loadChatInfo() {
        console.log("ChatView._loadChatInfo");

        var self = this;

        var fullChatInfoPath;

        if(this.subChatId) {
          fullChatInfoPath = "/users/" + this.user.uid + "/requests/" + this.requestId + "/chats/" + this.subChatId;
        } else {
          fullChatInfoPath = "/users/" + this.user.uid + "/requests/" + this.requestId;
        }

        //console.log("fullChatInfoPath = " + fullChatInfoPath);

        firebase.app("polyn-app").database().ref(fullChatInfoPath).once('value').then(function(snapshot) {

            var chatInfo = snapshot.val();

            if(chatInfo) {

              self.chatInfo = chatInfo;
              self.chatMessagesId = chatInfo.chatId;

              //console.log("chatInfo: " + JSON.stringify(chatInfo, null, 4));

              // As soon as we get the user and the chat info - get the other 
              // users info so we know who we're chatting with.
              var otherUsersId;

              if(self.subChatId) {
                // If the subChatId is set - we're looking at our own request and the info about the chat is in a list of chats.
                // This means the other user is the seller!
                otherUsersId = self.chatInfo.sellerId;
              } else {
                // If the subChatId is NOT set - there is no chats list since there is only one chat to see.
                // In this case - we're the seller.
                  otherUsersId = self.chatInfo.buyerId;
              }

              //console.log("otherUsersId = " + otherUsersId);

              if(otherUsersId) {

                firebase.app("polyn-app").database().ref("/users/" + otherUsersId + "/info").once('value').then(function(snapshot) {

                    var otherUsersInfo = snapshot.val();
                    //console.log("otherUsersInfo: " + JSON.stringify(otherUsersInfo, null, 4));

                    if(otherUsersInfo) {

                      self.otherUsersInfo = otherUsersInfo;
                      self._loadChats();
                    }
                });
              }
            }
        });
      }

      _requestNotificationPermission() {
        console.log("ChatView._requestNotificationPermission");

        this.$.messaging.activate();
        this.$.messaging.requestPermission()
          .then(() => {
            console.log('Notification Message permission granted!');
          })
          .catch((err) => {
            console.log('Notification Message permission denied!');
          });
      }

      _onTapImageBtn() {
        console.log("ChatView._onTapImageBtn");
        this.$.camera.click();
      }

      _onTapSendDialogBtn() {
        console.log("ChatView._onTapSendDialogBtn: message = " + this.$.message.value);

        if(!this.$.message.value && !this.chatPhotoUrl) {
          return;
        }

        var self = this;

        if(this.chatMessagesId) {
          this._sendChatMessage();
        } else {

          // We don't have a chatMessagesId yet so create it first and then send a message.
          var newChatMessageKey = firebase.app("polyn-app").database().ref().child("chats/").push().key;

          if(newChatMessageKey) {

            this.chatMessagesId = newChatMessageKey;

            // Save the chatMessagesId back to the chat entry.
            firebase.app("polyn-app").database().ref().child("/users/" + this.user.uid + "/requests/" + this.requestId + "/chatId").set(newChatMessageKey);

              // console.log("this.chatInfo.buyerId = " + this.chatInfo.buyerId);
              // console.log("this.chatInfo.requestId = " + this.chatInfo.requestId);

              var newOthersChatMessageKey = firebase.app("polyn-app").database().ref().child("/users/" + this.chatInfo.buyerId + "/requests/" + this.chatInfo.requestId + "/chats").push().key;
              if(newOthersChatMessageKey) {

                // console.log("chatId = " + newChatMessageKey);
                // console.log("seller = " + this.usersInfo.name);
                // console.log("sellerId = " + this.usersInfo.sellerId);

                let newChatEntry = {
                  chatId : newChatMessageKey,
                  seller : this.usersInfo.name,
                  sellerId: this.user.uid,
                  timeStamp: firebase.database.ServerValue.TIMESTAMP
                };

                firebase.app("polyn-app").database().ref().child("/users/" + this.chatInfo.buyerId + "/requests/" + this.chatInfo.requestId + "/chats/" + newOthersChatMessageKey).set(newChatEntry);
              }

            // Set the fake message from the buyer so the chat thread starts off with some context.
            var firstMessage = {
              name: this.otherUsersInfo.name,
              text: this.chatInfo.desc,
              senderId: this.chatInfo.buyerId,
              photoThumbURL: this.otherUsersInfo.photoThumbURL,
              timeStamp: firebase.database.ServerValue.TIMESTAMP
            };

            this.chatMessages = []; // Get rid of the faked message.

            const newKey = firebase.app("polyn-app").database().ref().child("chats/" + this.chatMessagesId).push().key;

            firebase.app("polyn-app").database().ref("chats/" + this.chatMessagesId + "/" + newKey).set(firstMessage).then(function() {

              // Now, that we have a chatMessagesId - load the chats so we get our first one.
              self._loadChats();
              self._sendChatMessage();
            });
          }
        }
      }

      _uploadChatPhoto(file) {
        console.log("ChatView._uploadChatPhoto");

        var self = this;

        // Upload the image to Cloud Storage.
        var newImageKey = firebase.app("polyn-app").database().ref().child("users/" + self.user.uid + "/chatphotos").push().key;

        firebase.app("polyn-app").storage().ref("users/" + self.user.uid + "/chatphotos" + "/" + newImageKey).put(file).then(function(snapshot) {
          //console.log("snapshot.downloadURL = " + snapshot.downloadURL);
          self.chatPhotoUrl = snapshot.downloadURL;
          self._sendChatMessage();
        });
      }

      _sendChatMessage() {
        console.log("ChatView._sendChatMessage");

        if(!this.$.message.value && !this.chatPhotoUrl) {
          return;
        }

        const text = this.$.message.value;
        const photoUrl = this.chatPhotoUrl;

        const newKey = firebase.app("polyn-app").database().ref().child("chats/" + this.chatMessagesId).push().key;

        var chatMessage = {
          name: this.usersInfo.name,
          senderId: this.user.uid,
          timeStamp: firebase.database.ServerValue.TIMESTAMP
        };

        if(text) {
          chatMessage.text = text;
        }

        if(photoUrl) {
          chatMessage.photoUrl = photoUrl;
        }

        // Write the new chat message under a new key, which is under the existing chat mnessage thread id.
        firebase.app("polyn-app").database().ref("chats/" + this.chatMessagesId + "/" + newKey).set(chatMessage);

        // Empty the message input.
        this.$.message.value = "";
        this.chatPhotoUrl = null;

        if(this.otherUsersInfo.token) {

          var params = {
            token: this.otherUsersInfo.token,
            title: this.usersInfo.name + " sent you a message.",
            body: text,
            icon: "/images/vr-msg.png",
            click_action: "https://vinylrecords.io/"
          };

          console.log("  Sending message: " + JSON.stringify(params, null, 4));

          this.$.sendMessage.params = params;
          this.$.sendMessage.generateRequest();
        } else {
          console.log("  No token found for: " + this.otherUsersInfo.name);
        }
      }

      _handleSendMessageResponse(data) {
        console.log("ChatView._handleSendMessageResponse");
        console.log("  status = " + data.detail.status);
      }

      _handleSendMessageError(e) {
        console.log("ChatView._handleSendMessageError");
        console.log("  status = ", e.status, e.statusText);
      }
    }

    window.customElements.define(ChatView.is, ChatView);
  </script>
</dom-module>