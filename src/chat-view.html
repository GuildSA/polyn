<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-behavior.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html"
<link rel="import" href="shared-styles.html">

<dom-module id="chat-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      .business-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
      }

      .business-name {
        padding: 10px;
      }

      .flex-horizontal {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-end-justified;
      }

       #message {
         --paper-input-container-focus-color: #70C187;
      }

      .message-container-main {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .message-sender-container {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-around-justified;
        background: white;
        border-radius: 5px;
        max-width: 400px;
        margin: auto;
            
      }

      .profile-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
      }

      #send-button {
        background-color: #70C187;
        color: white; 
      }

      .title {
        @apply --layout-horizontal;
        @apply --layout-center-justified; 
        @apply --layout-center;
        background-color: white; 
        
      }

      .username {
        padding: 10px;
      }
    </style>

    <firebase-auth 
      id="auth"
      app-name="polyn-app"
      user="{{user}}">
    </firebase-auth>

    <firebase-query
      id="query"
      app-name="polyn-app"
      path="/chats/[[chatMessagesId]]"
      data="{{chatMessages}}">
    </firebase-query>

    <firebase-document
      app-name="polyn-app"
      id="usersinfo"
      data="{{usersInfo}}">
    </firebase-document>

    <firebase-document
      app-name="polyn-app"
      id="chatinfo"
      path="/users/[[user.uid]]/chats/[[chatInfoId]]"
      data="{{chatInfo}}">
    </firebase-document>

    <firebase-document
      app-name="polyn-app"
      id="otherusersinfo"
      data="{{otherUsersInfo}}">
    </firebase-document>

    <firebase-messaging
      id="messaging"
      app-name="polyn-app"
      token="{{token}}">
    </firebase-messaging>

    <firebase-document
      app-name="polyn-app"
      path="/users/[[user.uid]]/info/token"
      data="[[token]]">
    </firebase-document>

    <app-indexeddb-mirror 
      session="[[user.uid]]" 
      key="chats/[[chatMessagesId]]" 
      data="{{chatMessages}}" 
      persisted-data="{{persistedChatMessages}}">
    </app-indexeddb-mirror>

    <iron-ajax
      id="sendMessage"
      url="https://us-central1-polyn-3c431.cloudfunctions.net/sendMessage"
      method="POST"
      loading="{{loading}}"
      on-response="_handleSendMessageResponse"
      on-error="_handleSendMessageError"
      debounce-duration="300">
    </iron-ajax>

    <paper-spinner id="spinner" active="[[loading]]" active></paper-spinner>

    <div class="title">
      <div class="business-photo">
        <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="profile-pic" preload fade src="images/RecordStoreDayLogo.jpg" class="item" on-tap="_onTapBusiness" ></iron-image>
      </div>
      <div class="business-name">
        Conversation between you and @Seller 
      <p style="margin: 0px;">www.recordStoreWebsite.com</p>
      </div>
     </div>

    <dom-repeat items="[[persistedChatMessages]]" as="chatMessage">
      <template>
       <div class="message-container-main"> 
        <div class="card">
          <p>[[chatMessage.text]]</p>

            <div class="flex-horizontal">
              <div class="user-photo">
                <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="business-pic" preload fade src="images/anonymous_profile.png" class="item" on-tap="_onTapBusiness" ></iron-image> 
              </div>
              <div class="username">
                Username 
              </div>           
            </div>
          </div>
      </template>
    </dom-repeat>
  
    <div class="message-sender-container">
      <paper-input id="message" label="Message..."></paper-input>
      <paper-button id="send-button" on-tap="_onTapSendDialogBtn" dialog-confirm autofocus raised>Send</paper-button>
    </div>
      

  </template>

  <script>
    class ChatView extends Polymer.Element {

      static get is() { return 'chat-view'; }

      static get properties() {
        return {
          chatMessagesId: {
            type: String,
            observer: '_chatMessagesIdChanged'
          },
          chatInfoId: {
            type: String,
            observer: '_chatInfoIdChanged'
          },
          user: {
            type: Object,
            observer: '_userChanged'
          },
          usersInfo: {
            type: Object,
            observer: '_usersInfoChanged'
          },
          chatInfo: {
            type: Object,
            observer: '_chatInfoChanged'
          },
          otherUsersInfo: {
            type: Object,
            observer: '_otherUsersInfoChanged'
          },
          loading: {
            type: Boolean,
            notify: true,
            value: false
          }
        };
      }

      _chatMessagesIdChanged() {
        console.log("ChatView._chatMessagesIdChanged: " + this.chatMessagesId);
      }

      _chatInfoIdChanged() {
        console.log("ChatView._chatInfoIdChanged: " + this.chatInfoId);
      }

      _userChanged(user) {
        console.log("ChatView._userChanged");
        //console.log("ChatView._userChanged: " + JSON.stringify(user, null, 4));

        // As soon as we get the user - get the users info so we can 
        // learn more about them!
        if(user && user.uid) {
          this.$.usersinfo.path = "/users/" + user.uid + "/info";
        }
      }

      _usersInfoChanged(e) {
        console.log("ChatView._usersInfoChanged: " + JSON.stringify(e, null, 4));
      }

      _chatInfoChanged(e) {
        console.log("ChatView._chatInfoChanged: " + JSON.stringify(e, null, 4));

        if(!this.user || !this.chatInfo) {
          return;
        }

        // As soon as we get the user and the chat info - get the other 
        // users info so we know who we're chatting with.
        var otherUsersId;

        if(this.user.uid == this.chatInfo.buyerId) {
          otherUsersId = this.chatInfo.sellerId; // The other user is the seller.
        } else {
          otherUsersId = this.chatInfo.buyerId; // The other user is the buyer.
        }

        if(otherUsersId) {
          this.$.otherusersinfo.path = "/users/" + otherUsersId + "/info";
        }
      }

      _otherUsersInfoChanged(usersInfo) {
        console.log("ChatView._otherUsersInfoChanged: " + JSON.stringify(usersInfo, null, 4));

// TODO: Is this the best way to check for an empty JSON object?
        if(!usersInfo || Object.keys(usersInfo).length === 0 && usersInfo.constructor === Object) {
           console.log(" usersInfo = null");
          return;
        }

        // If the user has no token - we should prompt for permisssion!
        if(!usersInfo.token) {
          this._requestNotificationPermission();
        }
      }

      _requestNotificationPermission() {
        console.log("ChatView._requestNotificationPermission");

        this.$.messaging.activate();
        this.$.messaging.requestPermission()
        .then(() => {
          console.log('Notification Message permission granted!');
        })
        .catch((err) => {
          console.log('Notification Message permission denied!');
        });
      }

      _onTapSendDialogBtn() {
        console.log("ChatView._onTapSendDialogBtn: message = " + this.$.message.value);

        // console.log("user " + JSON.stringify(this.user, null, 4));
        // console.log("this.user.uid " + this.user.uid);
        // console.log("this.user.displayName " + this.user.displayName);

        if(!this.$.message.value) {
          return;
        }

        if(this.chatMessagesId) {
          this._sendChatMessage();
        } else {

          // We don't have a chatMessagesId yet so create it first and then send a message.
          var newChatMessageKey = firebase.app("polyn-app").database().ref().child("chats/").push().key;

          if(newChatMessageKey) {

            this.chatMessagesId = newChatMessageKey;

            // Save the chatMessagesId back to the chat entry.
            firebase.app("polyn-app").database().ref().child("/users/" + this.user.uid + "/chats/" + this.chatInfoId + "/chatId").set(newChatMessageKey);
            this._sendChatMessage();
          }
        }
      }

      _sendChatMessage() {
        console.log("ChatView._sendChatMessage");

        var text = this.$.message.value;

        var newKey = firebase.app("polyn-app").database().ref().child("chats/" + this.chatMessagesId).push().key;

        var chatMessage = {
          name: this.usersInfo.name,
          senderId: this.user.uid,
          text: text,
          timeStamp: firebase.database.ServerValue.TIMESTAMP
        };

        // Write the new chat message under a new key, which is under the existing chat mnessage thread id.
        firebase.app("polyn-app").database().ref("chats/" + this.chatMessagesId + "/" + newKey).set(chatMessage);

        // Empty the message input.
        this.$.message.value = "";

        if(this.otherUsersInfo.token) {

          var params = {
            token: this.otherUsersInfo.token,
            title: this.usersInfo.name + " sent you a message.",
            body: text,
            icon: "/images/polyn-msg.png",
            click_action: "https://vinylrecords.io/"
          };

          console.log("  Sending message: " + JSON.stringify(params, null, 4));

          this.$.sendMessage.params = params;
          this.$.sendMessage.generateRequest();
        } else {
          console.log("  No token found for: " + this.otherUsersInfo.name);
        }
      }

      _handleSendMessageResponse(data) {
        console.log("ChatView._handleSendMessageResponse");
        console.log("  status = " + data.detail.status);
      }

      _handleSendMessageError(e) {
        console.log("ChatView._handleSendMessageError");
        console.log("  status = ", e.status, e.statusText);
      }
    }

    window.customElements.define(ChatView.is, ChatView);
  </script>
</dom-module>