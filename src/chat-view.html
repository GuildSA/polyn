<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-behavior.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="shared-styles.html">

<dom-module id="chat-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      .business-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
      }

      .business-name {
        padding: 10px;
      }

      .flex-horizontal {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-end-justified;
      }

      #message {
        --paper-input-container-focus-color: #70C187;
      }

      .message-container-main {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .message-sender-container {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-around-justified;
        background: white;
        border-radius: 5px;
        max-width: 400px;
        margin: auto;
        position: sticky;
        position: -webkit-sticky;
        bottom: 0px;
      }

      .profile-pic {
        width: 50px;
        height: 50px;
        border-radius: 50%;
      }

      #send-button {
        background-color: #70C187;
        color: white; 
      }

      .title {
        @apply --layout-horizontal;
        @apply --layout-center-justified; 
        @apply --layout-center;
        background-color: white; 
      }

      .username {
        padding: 10px;
      }


.module {
  max-width: 400px;
  margin: 20px auto;
}

.discussion {
  list-style: none;
  background: grey;
  margin: 0;
  padding: 0 0 50px 0;
}
.discussion li {
  padding: 0.5rem;
  overflow: hidden;
  display: flex;
}
.discussion .avatar {
  width: 40px;
  position: relative;
}
.discussion .avatar img {
  display: block;
  width: 100%;
}

.other .avatar:after {
  content: "";
  position: absolute;
  top: 0;
  right: 0;
  width: 0;
  height: 0;
  border: 5px solid white;
  border-left-color: transparent;
  border-bottom-color: transparent;
}

.self {
  justify-content: flex-end;
  align-items: flex-end;
}
.self .messages {
  order: 1;
  border-bottom-right-radius: 0;
}
.self .avatar {
  order: 2;
}
.self .avatar:after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0;
  height: 0;
  border: 5px solid white;
  border-right-color: transparent;
  border-top-color: transparent;
  box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

.messages {
  background: white;
  padding: 10px;
  border-radius: 2px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}
.messages p {
  font-size: 0.8rem;
  margin: 0 0 0.2rem 0;
}
.messages time {
  font-size: 0.7rem;
  color: #ccc;
}






    </style>

    <firebase-auth 
      id="auth"
      app-name="polyn-app"
      user="{{user}}">
    </firebase-auth>

    <firebase-document
      app-name="polyn-app"
      id="usersinfo"
      data="{{usersInfo}}">
    </firebase-document>

    <firebase-query
      id="query"
      app-name="polyn-app"
      path="/chats/[[chatMessagesId]]"
      data="{{chatMessages}}">
    </firebase-query>

    <firebase-document
      app-name="polyn-app"
      id="chatinfo"
      path="/users/[[user.uid]]/requests/[[requestId]]"
      data="{{chatInfo}}">
    </firebase-document>

    <firebase-document
      app-name="polyn-app"
      id="otherusersinfo"
      data="{{otherUsersInfo}}">
    </firebase-document>

    <firebase-messaging
      id="messaging"
      app-name="polyn-app"
      token="{{token}}">
    </firebase-messaging>

    <firebase-document
      app-name="polyn-app"
      path="/users/[[user.uid]]/info/token"
      data="[[token]]">
    </firebase-document>

    <app-indexeddb-mirror 
      session="[[user.uid]]" 
      key="chats/[[chatMessagesId]]" 
      data="{{chatMessages}}" 
      persisted-data="{{persistedChatMessages}}">
    </app-indexeddb-mirror>

    <iron-ajax
      id="sendMessage"
      url="https://us-central1-polyn-3c431.cloudfunctions.net/sendMessage"
      method="POST"
      loading="{{loading}}"
      on-response="_handleSendMessageResponse"
      on-error="_handleSendMessageError"
      debounce-duration="300">
    </iron-ajax>

    <paper-spinner id="spinner" active="[[loading]]" active></paper-spinner>

    <div class="title">
      <div class="business-photo">
        <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="profile-pic" preload fade src="images/RecordStoreDayLogo.jpg" class="item" on-tap="_onTapBusiness" ></iron-image>
      </div>
      <div class="business-name">
        Conversation between you and @Seller 
      <p style="margin: 0px;">www.recordStoreWebsite.com</p>
      </div>
     </div>
     
    <section class="module">

     <ol class="discussion">
    <li class="other">
      <div class="avatar">
        <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="business-pic" preload fade src="images/anonymous_profile.png" class="item" on-tap="_onTapBusiness" ></iron-image> 
      </div>
      <div class="messages">
        <p>yeah, they do early flights cause they connect with big airports.  they wanna get u to your connection</p>
        <time datetime="2009-11-13T20:00">Timothy â€¢ 51 min</time>
      </div>
    </li>
    <li class="self">
      <div class="avatar">
        <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="business-pic" preload fade src="images/anonymous_profile.png" class="item" on-tap="_onTapBusiness" ></iron-image> 
      </div>
      <div class="messages">
        <p>That makes sense.</p>
        <p>It's a pretty small airport.</p>
        <time datetime="2009-11-13T20:14">37 mins</time>
      </div>
    </li>
    <li class="other">
      <div class="avatar">
        <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="business-pic" preload fade src="images/anonymous_profile.png" class="item" on-tap="_onTapBusiness" ></iron-image> 
      </div>
      <div class="messages">
        <p>Not sure if this is going to work</p>
        <p>
          but why not give it a shot.</p>
      </div>
    </li>
  </ol>
  
</section>


    <dom-repeat items="[[persistedChatMessages]]" as="chatMessage">
      <template>
       <div class="message-container-main"> 
        <div class="card">
          <p>[[chatMessage.text]]</p>

            <div class="flex-horizontal">
              <div class="user-photo">
                <iron-image style="height:50px; background-color: lightgray;" sizing="cover" class="business-pic" preload fade src="images/anonymous_profile.png" class="item" on-tap="_onTapBusiness" ></iron-image> 
              </div>
              <div class="username">
                Username 
              </div>           
            </div>
          </div>
      </template>
    </dom-repeat>
  
    <div class="message-sender-container">
      <paper-input id="message" label="Message..."></paper-input>
      <paper-button id="send-button" on-tap="_onTapSendDialogBtn" dialog-confirm autofocus raised type="submit">Send</paper-button>
    </div>
      
  </template>

  <script>
    class ChatView extends Polymer.Element {

      static get is() { return 'chat-view'; }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: '_userChanged'
          },
          usersInfo: {
            type: Object,
            observer: '_usersInfoChanged'
          },
          otherUsersInfo: {
            type: Object,
            observer: '_otherUsersInfoChanged'
          },
          requestId: {
            type: String
          },
          chatMessagesId: {
            type: String
          },
          chatInfo: {
            type: Object,
            observer: '_chatInfoChanged'
          },
          loading: {
            type: Boolean,
            notify: true,
            value: false
          }
        };
      }

      _userChanged(user) {
        console.log("ChatView._userChanged");

        // As soon as we get the user - get the users info so we can 
        // learn more about them!
        if(user && user.uid) {
          this.$.usersinfo.path = "/users/" + user.uid + "/info";
        }
      }

      _usersInfoChanged(usersInfo) {
        console.log("ChatView._usersInfoChanged");

// TODO: Is this the best way to check for an empty JSON object?
        if(!usersInfo || Object.keys(usersInfo).length === 0 && usersInfo.constructor === Object) {
          return;
        }

        // If the user has no token - we should prompt for permisssion!
        if(!usersInfo.token) {
          this._requestNotificationPermission();
        }
      }

      _chatInfoChanged(e) {
        console.log("ChatView._chatInfoChanged: " + JSON.stringify(e, null, 4));

        if(!this.user || !this.chatInfo) {
          return;
        }

        // As soon as we get the user and the chat info - get the other 
        // users info so we know who we're chatting with.
        var otherUsersId;

        if(this.user.uid == this.chatInfo.buyerId) {
          otherUsersId = this.chatInfo.sellerId; // The other user is the seller.
        } else {
          otherUsersId = this.chatInfo.buyerId; // The other user is the buyer.
        }

        if(otherUsersId) {
          this.$.otherusersinfo.path = "/users/" + otherUsersId + "/info";
        }
      }
      
      _otherUsersInfoChanged(otherUsersInfo) {
        console.log("ChatView._otherUsersInfoChanged: " + JSON.stringify(otherUsersInfo, null, 4));

      }

      _requestNotificationPermission() {
        console.log("ChatView._requestNotificationPermission");

        this.$.messaging.activate();
        this.$.messaging.requestPermission()
          .then(() => {
            console.log('Notification Message permission granted!');
          })
          .catch((err) => {
            console.log('Notification Message permission denied!');
          });
      }

      _onTapSendDialogBtn() {
        console.log("ChatView._onTapSendDialogBtn: message = " + this.$.message.value);

        if(!this.$.message.value) {
          return;
        }

        if(this.chatMessagesId) {
          this._sendChatMessage();
        } else {

          // We don't have a chatMessagesId yet so create it first and then send a message.
          var newChatMessageKey = firebase.app("polyn-app").database().ref().child("chats/").push().key;

          if(newChatMessageKey) {

            this.chatMessagesId = newChatMessageKey;

            // Save the chatMessagesId back to the chat entry.
            firebase.app("polyn-app").database().ref().child("/users/" + this.user.uid + "/requests/" + this.requestId + "/chatId").set(newChatMessageKey);

// console.log("this.chatInfo.buyerId = " + this.chatInfo.buyerId);
// console.log("this.chatInfo.requestId = " + this.chatInfo.requestId);

              var newOthersChatMessageKey = firebase.app("polyn-app").database().ref().child("/users/" + this.chatInfo.buyerId + "/requests/" + this.chatInfo.requestId + "/chats").push().key;
              if(newOthersChatMessageKey) {

// console.log("chatId = " + newChatMessageKey);
// console.log("seller = " + this.usersInfo.name);
// console.log("sellerId = " + this.usersInfo.sellerId);

                let newChatEntry = {
                  chatId : newChatMessageKey,
                  seller : this.usersInfo.name,
                  sellerId: this.usersInfo.sellerId,
                  timeStamp: firebase.database.ServerValue.TIMESTAMP
                };

                firebase.app("polyn-app").database().ref().child("/users/" + this.chatInfo.buyerId + "/requests/" + this.chatInfo.requestId + "/chats/" + newOthersChatMessageKey).set(newChatEntry);
              }

            this._sendChatMessage();
          }
        }
      }

      _sendChatMessage() {
        console.log("ChatView._sendChatMessage");

        var text = this.$.message.value;

        var newKey = firebase.app("polyn-app").database().ref().child("chats/" + this.chatMessagesId).push().key;

        var chatMessage = {
          name: this.usersInfo.name,
          senderId: this.user.uid,
          text: text,
          timeStamp: firebase.database.ServerValue.TIMESTAMP
        };

        // Write the new chat message under a new key, which is under the existing chat mnessage thread id.
        firebase.app("polyn-app").database().ref("chats/" + this.chatMessagesId + "/" + newKey).set(chatMessage);

        // Empty the message input.
        this.$.message.value = "";

        if(this.otherUsersInfo.token) {

          var params = {
            token: this.otherUsersInfo.token,
            title: this.usersInfo.name + " sent you a message.",
            body: text,
            icon: "/images/polyn-msg.png",
            click_action: "https://vinylrecords.io/"
          };

          console.log("  Sending message: " + JSON.stringify(params, null, 4));

          this.$.sendMessage.params = params;
          this.$.sendMessage.generateRequest();
        } else {
          console.log("  No token found for: " + this.otherUsersInfo.name);
        }
      }

      _handleSendMessageResponse(data) {
        console.log("ChatView._handleSendMessageResponse");
        console.log("  status = " + data.detail.status);
      }

      _handleSendMessageError(e) {
        console.log("ChatView._handleSendMessageError");
        console.log("  status = ", e.status, e.statusText);
      }
    }

    window.customElements.define(ChatView.is, ChatView);
  </script>
</dom-module>