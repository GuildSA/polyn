
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="shared-styles.html">

<dom-module id="messages-view">
    <template>
    <style include="shared-styles">
        :host {
        display: block;
        padding: 10px;
        }
    </style>

    <firebase-auth id="auth" app-name="goodz-app" user="{{user}}"></firebase-auth>

    <firebase-query
        id="query"
        app-name="goodz-app"
        path="/users/[[user.uid]]/chats"
        data="{{chats}}">
    </firebase-query>

    <app-indexeddb-mirror
        session="[[user.uid]]"
        key="chats"
        data="{{chats}}"
        persisted-data="{{persistedChats}}">
    </app-indexeddb-mirror>

    <dom-repeat items="[[persistedChats]]" as="chat">
        <template>
            <div class="card" on-tap="_onTappedCard">
                <p>subject: [[chat.subject]]</p>
                <p>buyer: [[chat.buyer]]</p>
                <p>seller: [[chat.seller]]</p>
                <p>chatId: [[chat.chatId]]</p>
            </div>
        </template>
    </dom-repeat>

  </template>

    <script>
        class MessagesView extends Polymer.Element {
            static get is() { return 'messages-view'; }

            _onTappedCard(e) {
                console.log("MessagesView._onTappedCard");

                // Which index was clicked?
                var index = e.model.index;
                console.info(index + ' was clicked.');

                // What object is stored at that index?
                console.info(this.$.query.data[index]);

                // What is the Firebase key for this data?
                console.info(this.$.query.data[index].$key);

                // Switch to the chat-view and pass the chatMessagesId.
                var goodzApp = document.getElementById("goodzApp");
                goodzApp.page = "chat-view";
                goodzApp.$.toolbarNavBtn.icon = "arrow-back"
                goodzApp.$.ironPages.selectedItem.chatMessagesId = this.$.query.data[index].chatId;
            }
        }

        window.customElements.define(MessagesView.is, MessagesView);
    </script>
</dom-module>
