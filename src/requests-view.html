
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="shared-styles.html">

<dom-module id="requests-view">
  <template>
  <style include="shared-styles">
    :host {
      display: block;
      padding: 10px;
    }

    .main-container {
      padding: 10px;
      display: flex;
      @apply --layout-vertical;
      @apply --layout-center;
    }

    h3 {
      font-family: Helvetica, sans-serif;
      color: #70C187;
    }

    p {
      font-family: Arial, Helvetica, sans-serif;
      color: #9B9B9B;
    }

    paper-button.submit {
        background-color: #70C187;
        color: white;
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
    }

    
  </style>
  <template is="dom-if" if="[[!hasMessages]]">
    <div class="main-container">
      <img src="images/svg/chatBubbles.svg">
      <h3> Welcome to the Message Center!</h3>
      <p> Tap the ‘Submit Request’ button to let your local record shops know you are looking for something amazing!</p>
      <paper-button class="submit">Submit Your Request</paper-button>
    </div>
  </template>

  <firebase-auth
    id="auth" 
    app-name="polyn-app" 
    user="{{user}}">
  </firebase-auth>

  <firebase-query
    id="query"
    app-name="polyn-app"
    path="/users/[[user.uid]]/requests"
    data="{{requests}}">
  </firebase-query>

  <app-indexeddb-mirror
    session="[[user.uid]]"
    key="requests"
    data="{{requests}}"
    persisted-data="{{persistedRequests}}">
  </app-indexeddb-mirror>

  <dom-repeat items="[[persistedRequests]]" as="request" initial-count="5">
    <template>
      <div class="card" on-tap="_onTappedRequest">
        <h2>[[request.subject]]</h2>
        <p>[[request.body]]</p>
      </div>
    </template>
  </dom-repeat>

  </template>

  <script>
    class RequestsView extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'requests-view'; }

      static get properties() {
        return {
          user: {
            type: Object
          },
          hasMessages: {
            type: String,
            value: false
          }
        };
      }
  
      ready() {
        super.ready();
        console.log("RequestsView.ready");

        this.hasMessages = false;
      }

      _onTappedRequest(e) {
        console.log("RequestsView._onTappedRequest");

        if(!this.user) {
          return;
        }

        const index = e.model.index;

        // Did the user create this request - if not - the current user is a seller.
        if(this.user.uid != this.$.query.data[index].buyerId) {

          // Have we already created a chat session with this buyer?
          if(this.$.query.data[index].chatId) {

            // We've already created a chatId for this buyer - so load the chat session.
            var polynApp = document.getElementById("polynApp");
            var chatView = polynApp.pushPageOnCurrentTab("chat-view");
            chatView.chatInfoId = this.$.query.data[index].$key;
            chatView.chatMessagesId = this.$.query.data[index].chatId;

          } else {

            // No chat ID yet.
            var polynApp = document.getElementById("polynApp");
            var chatView = polynApp.pushPageOnCurrentTab("chat-view");
            chatView.chatInfoId = this.$.query.data[index].$key
          }

        } else {

          // The current user is the buyer who made this request!

          // If there are any chats from any sellers - list them.
          if(this.$.query.data[index].chats) {
            
            var polynApp = document.getElementById("polynApp");
            var messagesView = polynApp.pushPageOnCurrentTab("messages-view");
            messagesView.requestId = this.$.query.data[index].$key;

          } else {
            console.log("No sellers have created a chat session yet.");
          }
        }
      }
    }

    window.customElements.define(RequestsView.is, RequestsView);
  </script>
</dom-module>
