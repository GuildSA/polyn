
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-behavior.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="shared-styles.html">

<dom-module id="requests-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      .main-container {
        padding: 10px;
        display: flex;
        @apply --layout-vertical;
        @apply --layout-center;
      }

      .description {
        display: flex;
        flex-direction: row;
        justify-content: center;
        word-wrap: break-word;
      }

      h3 {
        font-family: Helvetica, sans-serif;
        color: #70C187;
      }

      p {
        font-family: Arial, Helvetica, sans-serif;
        color: #9B9B9B;
      }

      paper-button.submit {
        background-color: #70C187;
        color: white;
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
      }

      #title-close {
        display: flex;
        flex-direction: row-reverse; 
        justify-content: center;
      }
      
    </style>

    <template is="dom-if" if="[[!hasMessages]]">
      <div class="main-container">
        <img src="images/svg/chatBubbles.svg">
        <h3> Welcome to the Message Center!</h3>
        <p> Tap the Create Requestâ€™ button to let your local record shops know you are looking for something amazing!</p>
        <paper-button class="submit" on-tap="_onTapCreateRequest">Create Request</paper-button>
      </div>
    </template>

    <firebase-auth
      id="auth" 
      app-name="polyn-app" 
      user="{{user}}">
    </firebase-auth>

    <app-indexeddb-mirror
      session="[[user.uid]]"
      key="requests"
      data="{{requests}}"
      persisted-data="{{persistedRequests}}">
    </app-indexeddb-mirror>

    <dom-repeat items="[[persistedRequests]]" as="request" initial-count="5">
      <template>
        <div class="card" on-tap="_onTappedRequest">
          <div id="title-close">
            <paper-icon-button id="toolbarNavBtn" icon="custom-icons:close"></paper-icon-button>
            <h2>[[request.title]]</h2>
          </div>
          <div class="description">
          <p>[[request.desc]]</p>
          </div>
        </div>
      </template>
    </dom-repeat>

    <template is="dom-if" if="[[loading]]">
      <div class="overlay">
        <p>Loading Requests...</p>
        <paper-spinner id="spinner" active="[[loading]]"></paper-spinner>
      </div>
    </template>

  </template>

  <script>
    class RequestsView extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'requests-view'; }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: '_userChanged'
          },
          hasMessages: {
            type: String,
            value: false
          },
          requests: {
            type: Array,
            value: []
          },
          loading: {
            type: Boolean,
            notify: true,
            value: true
          }
        };
      }
  
      _userChanged(user) {
        console.log("RequestsView._userChanged");
        //console.log("user: " + JSON.stringify(user, null, 4));

        if(user != null) {

          var self = this;

          firebase.app("polyn-app").database().ref("/users/" + user.uid + "/requests").once('value').then(function(snapshot) {

            snapshot.forEach(function(childSnapshot) {

                var childKey = childSnapshot.key;
                var childData = childSnapshot.val();
                //console.log("childKey = " + childKey);
                //console.log("childData: " + JSON.stringify(childData, null, 4));

                // Manually add the key for this data so we can pass it forward if selected.
                childData.key = childKey;

                self.push('requests', childData);
              });

              if(self.requests.length > 0) {
                self.hasMessages = true;
              }

              // No matter how fast it loads - show the spinner for at least 0.5 seconds.
              setTimeout(function() { self.loading = false; }, 500);
          });
        } else {
          this.requests = [];
          this.hasMessages = false;
          this.loading = false;
        }
      }

      _onTappedRequest(e) {
        console.log("RequestsView._onTappedRequest");

        if(!this.user) {
          return;
        }

        const index = e.model.index;

        //console.log("this.requests[index]: " + JSON.stringify(this.requests[index], null, 4));

        // Did the user create this request - if not - the current user is a seller.
        if(this.user.uid != this.requests[index].buyerId) {

          // Have we already created a chat session with this buyer?
          if(this.requests[index].chatId) {

            // We've already created a chatId for this buyer - so load the chat session.
            var polynApp = document.getElementById("polynApp");
            var chatView = polynApp.pushPageOnCurrentTab("chat-view");
            chatView.requestId = this.requests[index].key;

            if(typeof chatView.reload === 'function') {
              chatView.reload();
            }

          } else {

            // No chat ID yet.
            var polynApp = document.getElementById("polynApp");
            var chatView = polynApp.pushPageOnCurrentTab("chat-view");

            chatView.requestId = this.requests[index].key;

            if(typeof chatView.reload === 'function') {
              chatView.reload();
            }
          }

        } else {

          // The current user is the buyer who made this request!

          // If there are any chats from any sellers - list them.
          if(this.requests[index].chats) {
            
            var polynApp = document.getElementById("polynApp");
            var chatsView = polynApp.pushPageOnCurrentTab("chats-view");

            chatsView.requestId = this.requests[index].key;

            if(typeof chatsView.reload === 'function') {
              chatsView.reload();
            }

          } else {
            console.log("No sellers have created a chat session yet.");
          }
        }
      }

      _onTapCreateRequest() {
        console.log("RequestsView._onTapCreateRequest");
        var polynApp = document.getElementById("polynApp");
        var requestView = polynApp.pushPageOnCurrentTab("request-view");
      }
    }

    window.customElements.define(RequestsView.is, RequestsView);
  </script>
</dom-module>
