<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="utility.html">

<dom-module id="profile-view">
  <template>

    <style include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: flex;
      }

      #profileImage {
        width: 200px;
        height: 200px;
        border-radius: 50%;
      }

      paper-button.sign-in {
        background-color: #70C187;
        color: white;
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
      }

      paper-input {
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
         --paper-input-container-focus-color: #70C187;
      }

      #continue-btn {
        background-color: #70C187;
        color: white; 
      }

      #google-btn {
        background-color: #3D88EC; 
      }

      #facebook-btn {
        background-color: #4069AD;
        color: white;
      }

      #sign-out-btn {
        background-color: var(--app-primary-color);
        color: white;
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
      }

      #twitter-btn {
        background-color: #0084B4;
        color: white;
      }

      #tos {
        color: lightgray;
        font-size: 0.5em;
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
      }

    </style>

    <firebase-auth
      id="auth"
      app-name="polyn-app"
      signed-in="{{signedIn}}"
      user="{{user}}"
      status-known="{{statusKnown}}"
      on-error="_handleError">
    </firebase-auth>

    <firebase-document
      app-name="polyn-app"
      id="usersinfo"
      data="{{usersInfo}}">
    </firebase-document>

    <div class="flex layout horizontal center-justified">
      <div class="card">

        <template is="dom-if" if="[[!user]]">
          <div class="layout horizontal center-justified">
            <img src="/images/svg/VinylRecord.svg" id="profileImage" alt="Anonymous Profile Image." >
          </div>
          <div class="layout vertical">
            <paper-input id="email" label="Email"></paper-input>
          </div>
          <div class="layout vertical">
            <paper-input id="password" type="password" label="Password"></paper-input>
          </div>
        </template>

        <template is="dom-if" if="[[user]]">
          <div class="layout horizontal center-justified">
            <iron-image sizing="contain" id="profileImage" alt="User's' Profile Image." src="[[photoURL]]" on-tap="_onTapProfilePhoto"></iron-image>
          </div>
          <div class="layout horizontal center-justified">
            <h1>Welcome [[displayName]]</h1>
          </div>
        </template>
      
        <input id="camera" type="file" name="photo" accept="image/*;capture=camera" style="display:none;"></input>

        <template is="dom-if" if="[[!user]]">
          <div class="layout vertical">
            <paper-button class="sign-in" id="continue-btn">Continue</paper-button>
            <div class="layout horizontal center-justified">
              <h4>OR</h4>
            </div>
            <paper-button class="sign-in" id="google-btn" on-tap="_onTapSignInUsingGmail">Sign In Using Gmail</paper-button>
            <paper-button class="sign-in" id="facebook-btn" on-tap="_onTapSignInUsingFacebook">Sign In Using Facebook</paper-button>
            <!--<paper-button class="sign-in" id="twitter-btn" on-tap="_onTapSignInUsingTwitter" raised>Sign In Using Twitter</paper-button>-->
          </div>
          <div class="layout horizontal center-justified">
            <div id="tos">Creating an account means you agree with our Terms of Service, Privacy Policy</div>
          </div>
        </template>

        <template is="dom-if" if="[[user]]">
          <div class="layout vertical">
            
            <template is="dom-if" if="[[!usersInfo.sellerId]]">
              <paper-button id="registerBusiness" class="sign-in" on-tap="_onTapRegisterBusiness">Register Your Business</paper-button>
            </template>

            <template is="dom-if" if="[[usersInfo.sellerId]]">
              <paper-button id="registerBusiness" class="sign-in" on-tap="_onTapRegisterBusiness">Edit Your Business</paper-button>
            </template>

            <paper-button id="sign-out-btn" on-tap="_onTapSignOut">Sign Out</paper-button>
          </div>
        </template>

      </div>
    </div>

  </template>

  <script>
    class ProfileView extends Polymer.GestureEventListeners(Polymer.Element) {

      static get is() { return 'profile-view'; }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: '_userChanged'
          },
          signedIn: {
            type: Object
          },
          statusKnown:{
            type: Object
          },
          usersInfo: {
            type: Object,
            observer: '_usersInfoChanged'
          },
          displayName: {
            type: String
          },
          photoURL: {
            type: String
          },
          croppedImage: {
            type: Object,
            observer: '_croppedImageChanged'
          },
          editingProfileImage: {
            type: Boolean,
            observer: '_editingProfileImageChanged'
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("ProfileView.connectedCallback")

        var self = this;
        var camera = this.$.camera;

        // Use the hidden input called 'camera' to get a photo from the user 
        // if they tap their profile photo!
        camera.addEventListener('change', function(e) {

          var file = e.target.files[0];

          if(!file) {
            Utility.showErrorToast("No image file selcted.");
            return;
          }

          if(!file.type.match('image.*')) {
            Utility.showErrorToast("You can only share images.");
            return;
          }

          self.editingProfileImage = true;

          var polynApp = document.getElementById("polynApp");
          var cropperView = polynApp.pushPageOnCurrentTab("cropper-view");
          cropperView.file = file;
          cropperView.prevPage = self;
        });
      }

      _croppedImageChanged(croppedImage) {
        console.log("ProfileView._croppedImageChanged: " + croppedImage);

        if(croppedImage) {
          this.photoURL = URL.createObjectURL(croppedImage);
          this._uploadUsersProfilePhoto(croppedImage);
          this.editingProfileImage = false;
        }
      }

      _editingProfileImageChanged(val) {
        console.log("ProfileView._editingProfileImageChanged: " + val);

        if(val == false) {
          this.$.camera.value = null;
        }
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        console.log("ProfileView.disconnectedCallback");
      }

      _uploadUsersProfilePhoto(file) {
        console.log("ProfileView._uploadUsersProfilePhoto");

        var self = this;

        // Upload the image to Cloud Storage.
        firebase.app("polyn-app").storage().ref("users/" + this.user.uid + "/photo").put(file).then(function(snapshot) {
          // Get the file's storage URI and save into the database under the user's info key.
          self._setUsersProfilePhotoURL(snapshot.downloadURL);

          // Create a thumbnail version of the profile image.
          Utility.resizeImageToSpecificWidth(file, 100, function(dataUrl) {

            var thumbnailBlob = Utility.dataURLtoBlob(dataUrl);

            firebase.app("polyn-app").storage().ref("users/" + self.user.uid + "/photoThumb").put(thumbnailBlob).then(function(snapshot) {
              console.log("snapshot.downloadURL = " + snapshot.downloadURL);
              self._setUsersProfilePhotoThumbURL(snapshot.downloadURL);
            });
          });
        });
      }

      _setUsersProfilePhotoURL(url) {
        console.log("ProfileView._setUsersProfilePhotoURL");
        firebase.app("polyn-app").database().ref().child("/users/" + this.user.uid + "/info/photoURL").set(url);
      }

      _setUsersProfilePhotoThumbURL(url) {
        console.log("ProfileView._setUsersProfilePhotoThumbURL");
        firebase.app("polyn-app").database().ref().child("/users/" + this.user.uid + "/info/photoThumbURL").set(url);
      }

      _handleError(e, err) {
        alert(err);
      }

      _userChanged(user) {
        console.log("ProfileView._userChanged");
        //console.log("user: " + JSON.stringify(user, null, 4));

        if(user != null) {

            if(user.isAnonymous == false) {
              // As soon as we get the user - verify the users info data.
              this._verifyUserInfo(user);
            }

        } else {

            this.displayName = "";
            this.photoURL = "";
        }
      }

      _usersInfoChanged(usersInfo) {
        console.log("ProfileView._usersInfoChanged");

// // TODO: Is this the best way to check for an empty JSON object?
//         if(!usersInfo || Object.keys(usersInfo).length === 0 && usersInfo.constructor === Object) {
//           return;
//         }

        // if(usersInfo.sellerId) {
        //   this.$.registerBusiness.textContent = "Edit Business";
        // }

        if(usersInfo.photoURL) {
          this.photoURL = usersInfo.photoURL;
        }

        if(usersInfo.name) {
          this.displayName = usersInfo.name;
        }
      }

      _onTapProfilePhoto() {
        console.log("ProfileView._onTapProfilePhoto")
        this.$.camera.click();
      }

      _verifyUserInfo(user) {
        console.log("ProfileView._verifyUserInfo");

        var self = this;

        const refPath = "/users/" + user.uid + "/info";

        firebase.app("polyn-app").database().ref(refPath).once('value').then(function(snapshot) {

          var usersInfo = snapshot.val();

          if(usersInfo) {

            // The user's info key exists - so update it if anything is missing.

            console.log("  usersInfo: " + JSON.stringify(usersInfo, null, 4));

            var info = {};

            // If name, email or photoURL is missing - add them!
            if(!usersInfo.name || !usersInfo.email || !usersInfo.photoURL) {

              if(!usersInfo.name) {
                // Force set this now, so the user can at least see something.
                self.displayName = user.providerData[0].displayName;

                info.name = user.providerData[0].displayName;
              }

              if(!usersInfo.email) {
                info.email = user.providerData[0].email;
              }

              if(!usersInfo.photoURL) {
                // Force set this now, so the user can at least see something.
                self.photoURL = user.providerData[0].photoURL;

                self._setUsersProfilePhotoURL(user.providerData[0].photoURL);

// TODO: Upload a copy of the image pulled from social including a thumbnail.

                // // Create a thumbnail version of the profile image.
                // var blob = Utility.dataURLtoBlob(user.providerData[0].photoURL);
                // Utility.resizeImageToSpecificWidth(blob, 100, function(dataUrl) {

                //   var thumbnailBlob = Utility.dataURLtoBlob(dataUrl);

                //   firebase.app("polyn-app").storage().ref("users/" + self.user.uid + "/photoThumb").put(thumbnailBlob).then(function(snapshot) {
                //     console.log("snapshot.downloadURL = " + snapshot.downloadURL);
                //     self._setUsersProfilePhotoThumbURL(snapshot.downloadURL);
                //   });
                // });

              }

              // If we have a token - preserve it.
              if(usersInfo.token) {
                info.token = usersInfo.token;
              }

              firebase.app("polyn-app").database().ref(refPath).update(info);
            }

          // Now, get the users info so we can learn more about them!
          self.$.usersinfo.path = "/users/" + user.uid + "/info";

          } else {

            // Force set these now, so the user can at least see something.
            self.displayName = user.providerData[0].displayName;
            self.photoURL = user.providerData[0].photoURL;

            // The user's info key does NOT exist - so add one.
            var info = {};
            info.name = user.providerData[0].displayName;
            info.email = user.providerData[0].email;
            info.photoURL = user.providerData[0].photoURL;
            firebase.app("polyn-app").database().ref(refPath).update(info);
          }
        });
      }

      _onTapSignInUsingGmail() {
        console.log("ProfileView._onTapSignInUsingGmail");

        if(this.user == null) {
          this.$.auth.provider = "google";
          return this.$.auth.signInWithPopup();
        } else {
          console.log("  Already logged into an account!");
        }
      }

      _onTapSignInUsingFacebook() {
        console.log("ProfileView._onTapSignInUsingFacebook");

        if(this.user == null) {
          this.$.auth.provider = "facebook";
          return this.$.auth.signInWithPopup();
        } else {
          console.log("  Already logged into an account!");
        }
      }

      // _onTapSignInUsingTwitter() {
      //   console.log("ProfileView._onTapSignInUsingTwitter");
      //
      //   if(this.user == null) {
      //     this.$.auth.provider = "twitter";
      //     return this.$.auth.signInWithPopup();
      //   } else {
      //     console.log("  Already logged into an account!");
      //   }
      // }

      _onTapSignOut() {
        console.log("ProfileView._onTapSignOut");
        return this.$.auth.signOut();

// TODO: Force the app to reset all tab view stacks after logout!
      }

      _onTapRegisterBusiness() {
        console.log("ProfileView._onTapRegisterBusiness");

        var polynApp = document.getElementById("polynApp");
        var sellerInfoView = polynApp.pushPageOnCurrentTab("sellerinfo-view");
      }
    }

    window.customElements.define(ProfileView.is, ProfileView);
  </script>
</dom-module>
