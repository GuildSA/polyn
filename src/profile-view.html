
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="shared-styles.html">

<dom-module id="profile-view">
  <template>

    <style include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: flex;
        /*background-color: lightblue;*/
        /*height: 100%;*/
      }

      #profile-image {
        width: 200px;
        height: 200px;
        border-radius: 50%;
      }

      paper-button.sign-in {
        background-color: #70C187;
        color: white;
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
      }

      paper-input {
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
         --paper-input-container-focus-color: #70C187;
      }

      #continue-btn {
        background-color: #70C187;
        color: white; 
      }

      #google-btn {
        background-color: #3D88EC; 
      }

      #facebook-btn {
        background-color: #4069AD;
        color: white;
      }

      #sign-out-btn {
        background-color: var(--app-primary-color);
        color: white;
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
      }

      #twitter-btn {
        background-color: #0084B4;
        color: white;
      }

      #tos {
        color: lightgray;
        font-size: 0.5em;
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
      }

    </style>

    <firebase-auth
      id="auth"
      app-name="polyn-app"
      signed-in="{{signedIn}}"
      user="{{user}}"
      status-known="{{statusKnown}}"
      on-error="_handleError">
    </firebase-auth>

    <div class="flex layout horizontal center-justified">
      <div class="card">

        <template is="dom-if" if="[[isAnonymous]]">
          <div class="layout horizontal center-justified">
            <img src="/images/svg/VinylRecord.svg" id="profile-image" alt="Anonymous Profile Image." >
          </div>
          <div class="layout vertical">
            <paper-input id="email" label="Email"></paper-input>
          </div>
          <div class="layout vertical">
            <paper-input id="password" label="Password"></paper-input>
          </div>
        </template>

        <template is="dom-if" if="[[!isAnonymous]]">
          <div class="layout horizontal center-justified">
            <iron-image sizing="contain" id="profile-image" alt="User's' Profile Image." src="[[photoURL]]"></iron-image>
          </div>
          <div class="layout horizontal center-justified">
            <h1>Welcome [[displayName]]</h1>
          </div>
        </template>
      
        <template is="dom-if" if="[[isAnonymous]]">
          <div class="layout vertical">
            <paper-button class="sign-in" id="continue-btn">Continue</paper-button>
            <div class="layout horizontal center-justified">
              <h4>OR</h4>
            </div>
            <paper-button class="sign-in" id="google-btn" on-tap="_onTapSignInUsingGmail">Sign In Using Gmail</paper-button>
            <paper-button class="sign-in" id="facebook-btn" on-tap="_onTapSignInUsingFacebook">Sign In Using Facebook</paper-button>
            <!--<paper-button class="sign-in" id="twitter-btn" on-tap="_onTapSignInUsingTwitter" raised>Sign In Using Twitter</paper-button>-->
          </div>
          <div class="layout horizontal center-justified">
            <div id="tos">Creating an account means you agree with our Terms of Service, Privacy Policy</div>
          </div>
        </template>

        <template is="dom-if" if="[[!isAnonymous]]">
          <div class="layout vertical">
            <paper-button id="registerbusiness" class="sign-in" on-tap="_onTapRegisterBusiness">Register Your Business</paper-button>
            <paper-button id="sign-out-btn" on-tap="_onTapSignOut">Sign Out</paper-button>
          </div>
        </template>

      </div>
    </div>

  </template>

  <script>
    class ProfileView extends Polymer.Element {

      static get is() { return 'profile-view'; }

      static get properties() {
        return {
          isAnonymous: {
            type: String,
            value: true
          },
          photoURL: {
            type: String
          },
          displayName: {
            type: String
          },
          signedIn: {
            type: Object
          },
          user: {
            type: Object,
            observer: '_userChanged'
          },
          statusKnown:{
            type: Object
          }
        };
      }

      _handleError(e, err) {
        alert(err);
      }

      _userChanged(user) {
        console.log("ProfileView._userChanged");
        console.log("user: " + JSON.stringify(user, null, 4));

        if(user != null) {

            console.log("  user.isAnonymous = " + user.isAnonymous);

            if(user.isAnonymous == false) {

              if(user.uid) {
                // As soon as we get the user - verify the users info data.
                this._verifyUserInfo(user);
              }

              // console.log("user.providerData: " + user.providerData);
              // console.log("user " + JSON.stringify(user, null, 4));
              // console.log("user.providerData: " + JSON.stringify(user.providerData, null, 4));
              // console.log("user.providerData[0].photoURL: " + user.providerData[0].photoURL);

              // If the user is not anonymous, get their name and photo.
              this.displayName = user.providerData[0].displayName;
              this.photoURL = user.providerData[0].photoURL;
            }           

            // This element keeps track of if its own isAnonymous property.
            // Using the one on user creates issues!
            this.isAnonymous = user.isAnonymous;

        } else {

            this.displayName = "";
            this.photoURL = "";
            this.isAnonymous = true;
        }
      }

      _verifyUserInfo(user) {
        console.log("ProfileView._verifyUserInfo");

        const refPath = "/users/" + user.uid + "/info";

        firebase.app("polyn-app").database().ref(refPath).once('value').then(function(snapshot) {

          var usersInfo = snapshot.val();

          if(usersInfo) {

            // The user's info key exists - so update it if anything is missing.

            console.log("  usersInfo: " + JSON.stringify(usersInfo, null, 4));

            var info = {};

            // If name or email is missing - add them!
            if(!usersInfo.name || !usersInfo.email) {

              if(!usersInfo.name) {
                info.name = user.providerData[0].displayName;
              }

              if(!usersInfo.email) {
                info.email = user.providerData[0].email;
              }

              // If we have a token - preserve it.
              if(usersInfo.token) {
                info.token = usersInfo.token;
              }

              firebase.app("polyn-app").database().ref(refPath).update(info);
            }

          } else {

            // The user's info key does NOT exist - so add one.
            var info = {};
            info.name = user.providerData[0].displayName;
            info.email = user.providerData[0].email;
            firebase.app("polyn-app").database().ref(refPath).update(info);
          }
        });
      }

      _onTapSignInUsingGmail() {
        console.log("ProfileView._onTapSignInUsingGmail");

        if(this.user == null) {
          this.$.auth.provider = "google";
          return this.$.auth.signInWithPopup();
        } else {
          console.log("  Already logged into an account!");
        }
      }

      _onTapSignInUsingFacebook() {
        console.log("ProfileView._onTapSignInUsingFacebook");

        if(this.user == null) {
          this.$.auth.provider = "facebook";
          return this.$.auth.signInWithPopup();
        } else {
          console.log("  Already logged into an account!");
        }
      }

      _onTapSignInUsingTwitter() {
        console.log("ProfileView._onTapSignInUsingTwitter");

        if(this.user == null) {
          this.$.auth.provider = "twitter";
          return this.$.auth.signInWithPopup();
        } else {
          console.log("  Already logged into an account!");
        }
      }

      _onTapSignOut() {
        console.log("ProfileView._onTapSignOut");
        return this.$.auth.signOut();
      }

      _onTapRegisterBusiness() {
        console.log("ProfileView._onTapRegisterBusiness");

        var polynApp = document.getElementById("polynApp");
        var sellerInfoView = polynApp.pushPageOnCurrentTab("sellerinfo-view");
      }
    }

    window.customElements.define(ProfileView.is, ProfileView);
  </script>
</dom-module>
