
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="shared-styles.html">

<dom-module id="profile-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      .column-layout {
        display: flex;
        flex-direction: column;
      }

      #profile-image {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        margin: auto;
        flex: 1;
      }

      paper-button.signout {
        background-color: var(--app-primary-color);
        color: white;
        position: absolute;
        bottom: 2.5%;
        right:0;
        left:0;
        align-content: center;
        --paper-button-raised-keyboard-focus: {
          background-color: var(--paper-pink-a200) !important;
          color: white !important;
        };
      }

      .center {
        margin: auto;
      }

    </style>

    <firebase-auth
        id="auth"
        app-name="goodz-app"
        signed-in="{{signedIn}}"
        user="{{user}}"
        status-known="{{statusKnown}}"
        provider="google"
        on-error="handleError">
    </firebase-auth>

     <div class="card">
      <div class="column-layout">

          <template is="dom-if" if="[[isAnonymous]]">
              <iron-image sizing="contain" id="profile-image" alt="Anonymous Profile Image." src="./images/anonymous_profile.png"></iron-image>
          </template>

          <template is="dom-if" if="[[!isAnonymous]]">
              <iron-image sizing="contain" id="profile-image" alt="User's' Profile Image." src="[[photoURL]]"></iron-image>
          </template>

          <template is="dom-if" if="[[!isAnonymous]]">
            <div class="center">
              <h1>Welcome [[displayName]]</h1>
            </div>
          </template>

          <template is="dom-if" if="[[isAnonymous]]">
            <paper-button class="custom signout" on-tap="login" raised>Sign In</paper-button>
          </template>

          <template is="dom-if" if="[[!isAnonymous]]">
            <paper-button class="custom signout" on-tap="logout" raised>Sign Out</paper-button>
          </template>
      <div>
    </div>

  </template>

  <script>
    class ProfileView extends Polymer.Element {
      static get is() { return 'profile-view'; }

      static get properties() {
        return {

            isAnonymous: {
              type: String,
              value: true
            },
            photoURL: {
              type: String
            },
            displayName: {
              type: String
            },

            signedIn: {
              type: Object
            },
            user: {
                type: Object,
                observer: '_userChanged'
            },
            statusKnown:{
                type: Object
            }
        };
      }

      handleError(e, err) {
          alert(err);
      }

      ready() {
          super.ready();
          console.log("ready called!");
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("connectedCallback called!");
      }


      disconnectedCallback() {
        super.disconnectedCallback();
        console.log("disconnectedCallback called!");
      }

      _userChanged(user) {

        console.log("_userChanged called!");

        console.log("user: " + JSON.stringify(user, null, 4));

        if(user != null) {

            console.log("user.isAnonymous: " + this.user.isAnonymous);

            if(user.isAnonymous == false) {

              console.log("user.providerData: " + user.providerData);
              console.log("user.providerData: " + JSON.stringify(user.providerData, null, 4));
              console.log("user.providerData[0].photoURL: " + user.providerData[0].photoURL);

              this.displayName = user.providerData[0].displayName;
              this.photoURL = user.providerData[0].photoURL;
            }           

            this.isAnonymous = user.isAnonymous;

        } else {

            this.displayName = "";
            this.photoURL = "";
            this.isAnonymous = true;
        }
      }

      _linkGoogleAccount() {

          console.log("_linkGoogleAccount called!");

// TODO: linkWithPopup error: Error: This credential is already associated with a different user account.

          var provider = new firebase.auth.GoogleAuthProvider();
          var that = this;

          this.user.linkWithPopup(provider).then(function(result) {
              console.log("linkWithPopup result: " + JSON.stringify(result, null, 4));

// TODO: These don't trigger a refresh like they should!
              //that.notifyPath('user', that.user)
              //that.set("user", result.user);
// HACK:
              that.user = result.user
              that._userChanged(result.user)

          }, function(error) {
              console.log("linkWithPopup error: " + error);
          }); 
      }

      login() {

        console.log("_linkGloginoogleAccount called!");

        if(this.user == null) {

          console.log("signInWithPopup");
          return this.$.auth.signInWithPopup();

        } else if(this.user.isAnonymous == true) {

          console.log("Calling _linkGoogleAccount");
          this._linkGoogleAccount();

        } else {

          console.log("Already logged into an account!");
        }
      }
      
      logout() {
          console.log("logout called!");
          return this.$.auth.signOut();
      }
    }

    window.customElements.define(ProfileView.is, ProfileView);
  </script>
</dom-module>
