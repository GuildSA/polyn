
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="shared-styles.html">

<dom-module id="profile-view">
  <template>

    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      #profile-image {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        margin: auto;
        flex: 1;
      }

      paper-button.bluebtn {
        background-color: var(--app-primary-color);
        color: white;
        margin-bottom: 8px;
        right:0;
        left:0;
        align-content: center;
        --paper-button-raised-keyboard-focus: {
          background-color: var(--paper-pink-a200) !important;
          color: white !important;
        };
      }

      .bottom {
        position: absolute;
        bottom: 2.5%;
      }

      .center {
        margin: auto;
        align-content: center;
      }
      .flex-center {
        @apply --layout-vertical;
        @apply --layout-center-justified;
      }

    </style>

    <firebase-auth
        id="auth"
        app-name="polyn-app"
        signed-in="{{signedIn}}"
        user="{{user}}"
        status-known="{{statusKnown}}"
        provider="google"
        on-error="_handleError">
    </firebase-auth>

     
     
        <div class="card flex-center">
          
           <template is="dom-if" if="[[isAnonymous]]">
              <iron-image sizing="contain" id="profile-image" alt="Anonymous Profile Image." src="./images/anonymous_profile.png"></iron-image>
           </template>

            <template is="dom-if" if="[[!isAnonymous]]">
              <iron-image sizing="contain" id="profile-image" alt="User's' Profile Image." src="[[photoURL]]"></iron-image>
            </template>

            <template is="dom-if" if="[[!isAnonymous]]">
              <div class="center">
                <h1>Welcome [[displayName]]</h1>
              </div>
            </template>

        </div>
         

          <template is="dom-if" if="[[isAnonymous]]">
            <div class="flex-center">
            <paper-button class="custom bluebtn" on-tap="_signInUsingGmail" raised>Sign In Using Gmail</paper-button>
            <paper-button class="custom bluebtn" on-tap="_signInUsingFacebook" raised>Sign In Using Facebook</paper-button>
            <paper-button class="custom bluebtn" on-tap="_signInUsingTwitter" raised>Sign In Using Twitter</paper-button>
            </div>
          </template>

          

          <template is="dom-if" if="[[!isAnonymous]]">
            <paper-button class="custom bluebtn bottom" on-tap="_signOut" raised>Sign Out</paper-button>
          </template>
      <div>
    </div>

  </template>

  <script>
    class ProfileView extends Polymer.Element {

      static get is() { return 'profile-view'; }

      static get properties() {
        return {
          isAnonymous: {
            type: String,
            value: true
          },
          photoURL: {
            type: String
          },
          displayName: {
            type: String
          },
          signedIn: {
            type: Object
          },
          user: {
            type: Object,
            observer: '_userChanged'
          },
          statusKnown:{
            type: Object
          }
        };
      }

      ready() {
        super.ready();
        console.log("ProfileView.ready");
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("ProfileView.connectedCallback");
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        console.log("ProfileView.disconnectedCallback");
      }

      _handleError(e, err) {
          alert(err);
      }

      _userChanged(user) {
        console.log("ProfileView._userChanged");

        // console.log("user: " + JSON.stringify(user, null, 4));

        if(user != null) {

            console.log("  user.isAnonymous: " + this.user.isAnonymous);

            if(user.isAnonymous == false) {

              // console.log("user.providerData: " + user.providerData);
              // console.log("user " + JSON.stringify(user, null, 4));
              // console.log("user.providerData: " + JSON.stringify(user.providerData, null, 4));
              // console.log("user.providerData[0].photoURL: " + user.providerData[0].photoURL);

              // If the user is not anonymous, get their name and photo.
              this.displayName = user.providerData[0].displayName;
              this.photoURL = user.providerData[0].photoURL;
            }           

            // This element keeps track of if its own isAnonymous property.
            // Using the one on user creates issues!
            this.isAnonymous = user.isAnonymous;

        } else {

            this.displayName = "";
            this.photoURL = "";
            this.isAnonymous = true;
        }
      }

      _linkGoogleAccount() {
          console.log("ProfileView._linkGoogleAccount");

          var provider = new firebase.auth.GoogleAuthProvider();
          var self = this;

          self.user.linkWithPopup(provider).then(function(result) {
            console.log("  result: " + JSON.stringify(result, null, 4));

// TODO: These don't trigger a refresh like they should!
            //that.notifyPath('user', that.user)
            //that.set("user", result.user);
// HACK:
            self.user = result.user
            self._userChanged(result.user)

          }, function(error) {

// TODO: Find a solution to "Error: This credential is already associated with a different user account."
            if(error.code == "auth/credential-already-in-use") {
// HACK: To fix this issue I'm basically abandoning the user's anonymous login in favor of their 
// Google login, but this UI flow forces the users to pick their Google account twice to pull this off.
// Is there a better way to do this?
              self.$.auth.signInWithRedirect(provider).then(function(result) {
                console.log("  result: " + JSON.stringify(result, null, 4));
              }, function(error) {
                console.log("  error: " + error);
              });

            } else {
              console.log("  error: " + error);
            }
          }); 
      }

      _signInUsingGmail() {
        console.log("ProfileView._signInUsingGmail");

        if(this.user == null) {
          console.log("  signInWithPopup");
          return this.$.auth.signInWithPopup();
        } else if(this.user.isAnonymous == true) {
          this._linkGoogleAccount();
        } else {
          console.log("  Already logged into an account!");
        }
      }
      
      _signInUsingFacebook() {
        console.log("ProfileView._signInUsingFacebook");

        if(this.user == null) {
          console.log("  signInWithPopup");
          this.$.auth.provider = "facebook"
          return this.$.auth.signInWithPopup();
        } else {
          console.log("  Already logged into an account!");
        }
      }

      _signInUsingTwitter() {
        console.log("ProfileView._signInUsingTwitter");

        if(this.user == null) {
          console.log("  signInWithPopup");
          this.$.auth.provider = "twitter"
          return this.$.auth.signInWithPopup();
        } else {
          console.log("  Already logged into an account!");
        }
      }

      _signOut() {
          console.log("ProfileView._logout");

          return this.$.auth.signOut();
      }
    }

    window.customElements.define(ProfileView.is, ProfileView);
  </script>
</dom-module>
