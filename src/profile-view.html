
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="shared-styles.html">

<dom-module id="profile-view">
  <template>

    <style include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: flex;
        /*background-color: lightblue;*/
        height: 100%;
      }

      #profile-image {
        width: 200px;
        height: 200px;
        border-radius: 50%;
      }

      paper-button.bluebtn {
        background-color: var(--app-primary-color);
        color: white;
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 8px;
      }

     .bottom {
        margin-top: auto
      }

    </style>

    <firebase-auth
      id="auth"
      app-name="polyn-app"
      signed-in="{{signedIn}}"
      user="{{user}}"
      status-known="{{statusKnown}}"
      on-error="_handleError">
    </firebase-auth>

    <firebase-document
      app-name="polyn-app"
      id="usersinfo"
      data="{{usersInfo}}">
    </firebase-document>

    <div class="flex layout vertical">

      <div class="card">
        <template is="dom-if" if="[[isAnonymous]]">
          <div class="layout horizontal center-justified">
            <iron-image sizing="contain" id="profile-image" alt="Anonymous Profile Image." src="./images/anonymous_profile.png"></iron-image>
          </div>
        </template>
        <template is="dom-if" if="[[!isAnonymous]]">
          <div class="layout horizontal center-justified">
            <iron-image sizing="contain" id="profile-image" alt="User's' Profile Image." src="[[photoURL]]"></iron-image>
          </div>
          <div class="layout horizontal center-justified">
            <h1>Welcome [[displayName]]</h1>
          </div>
        </template>
      </div>

      <template is="dom-if" if="[[isAnonymous]]">
        <div class="layout vertical bottom">
          <paper-button class="custom bluebtn" on-tap="_signInUsingGmail" raised>Sign In Using Gmail</paper-button>
          <paper-button class="custom bluebtn" on-tap="_signInUsingFacebook" raised>Sign In Using Facebook</paper-button>
          <paper-button class="custom bluebtn" on-tap="_signInUsingTwitter" raised>Sign In Using Twitter</paper-button>
        </div>
      </template>

      <template is="dom-if" if="[[!isAnonymous]]">
        <div class="layout vertical bottom">
          <paper-button class="custom bluebtn" on-tap="_signOut" raised>Sign Out</paper-button>
        </div>
      </template>

    </div>

  </template>

  <script>
    class ProfileView extends Polymer.Element {

      static get is() { return 'profile-view'; }

      static get properties() {
        return {
          isAnonymous: {
            type: String,
            value: true
          },
          photoURL: {
            type: String
          },
          displayName: {
            type: String
          },
          signedIn: {
            type: Object
          },
          user: {
            type: Object,
            observer: '_userChanged'
          },
          statusKnown:{
            type: Object
          },
          usersInfo: {
            type: String,
            notify: true,
            reflectToAttribute: true,
            observer: '_usersInfoChanged'
          }
        };
      }

      ready() {
        super.ready();
        console.log("ProfileView.ready");

        //this.usersInfoUpdated = false;
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("ProfileView.connectedCallback");
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        console.log("ProfileView.disconnectedCallback");
      }

      _handleError(e, err) {
          alert(err);
      }

      _userChanged(user) {
        console.log("ProfileView._userChanged");
        console.log("user: " + JSON.stringify(user, null, 4));

        if(user != null) {

            console.log("  user.isAnonymous: " + this.user.isAnonymous);

            if(user.isAnonymous == false) {

              // As soon as we get the user - get the users info so we can add to it!!
              if(user && user.uid) {

                // this.$.usersinfo.path = "/users/" + user.uid + "/info";

                if(user.providerData[0].displayName) {
                  this.$.usersinfo.path = "/users/" + user.uid + "/info/name";
                  this.$.usersinfo.data = this.user.providerData[0].displayName;
                }

                if(this.user.providerData[0].email) {
                  this.$.usersinfo.path = "/users/" + user.uid + "/info/email";
                  this.$.usersinfo.data = this.user.providerData[0].email;
                }
              }

              // console.log("user.providerData: " + user.providerData);
              // console.log("user " + JSON.stringify(user, null, 4));
              // console.log("user.providerData: " + JSON.stringify(user.providerData, null, 4));
              // console.log("user.providerData[0].photoURL: " + user.providerData[0].photoURL);

              // If the user is not anonymous, get their name and photo.
              this.displayName = user.providerData[0].displayName;
              this.photoURL = user.providerData[0].photoURL;
            }           

            // This element keeps track of if its own isAnonymous property.
            // Using the one on user creates issues!
            this.isAnonymous = user.isAnonymous;

        } else {

            this.displayName = "";
            this.photoURL = "";
            this.isAnonymous = true;
        }
      }

      _usersInfoChanged(usersInfo) {
        console.log("ProfileView._usersInfoChanged: " + JSON.stringify(usersInfo, null, 4));

        if(!usersInfo) {
           console.log(" usersInfo = null");
          return;
        }

// TODO: How can we get the data and then change it safely?

        // if(this.usersInfoUpdated) {
        //   return;
        // }

        //if(!usersInfo.name || !usersInfo.email) {

          //this.displayName = user.providerData[0].displayName;
          //this.photoURL = user.providerData[0].photoURL;

//           var info = {};

//           //if(!usersInfo.name) {
//             info.name = this.user.providerData[0].displayName;
//           //}

//           //if(!usersInfo.email) {
//             info.email = this.user.providerData[0].email;
//           //}

//           //if(!usersInfo.token) {
//             info.token = this.usersInfo.token;
//           //}

// this.usersInfoUpdated = true;

//           this.$.usersinfo.data = info;

        //}
      }

//      _linkGoogleAccount() {
//           console.log("ProfileView._linkGoogleAccount");
//
//           var provider = new firebase.auth.GoogleAuthProvider();
//           var self = this;
//
//           self.user.linkWithPopup(provider).then(function(result) {
//             console.log("  result: " + JSON.stringify(result, null, 4));
//
// // TODO: These don't trigger a refresh like they should!
//             //that.notifyPath('user', that.user)
//             //that.set("user", result.user);
// // HACK:
//             self.user = result.user
//             self._userChanged(result.user)
//
//           }, function(error) {
//
// // TODO: Find a solution to "Error: This credential is already associated with a different user account."
//             if(error.code == "auth/credential-already-in-use") {
// // HACK: To fix this issue I'm basically abandoning the user's anonymous login in favor of their 
// // Google login, but this UI flow forces the users to pick their Google account twice to pull this off.
// // Is there a better way to do this?
//               self.$.auth.signInWithRedirect(provider).then(function(result) {
//                 console.log("  result: " + JSON.stringify(result, null, 4));
//               }, function(error) {
//                 console.log("  error: " + error);
//               });
//
//             } else {
//               console.log("  error: " + error);
//             }
//           }); 
//       }

      _signInUsingGmail() {
        console.log("ProfileView._signInUsingGmail");

        if(this.user == null) {
          console.log("  signInWithPopup");
          this.$.auth.provider = "google";
          return this.$.auth.signInWithPopup();
        // } else if(this.user.isAnonymous == true) {
        //   this._linkGoogleAccount();
        } else {
          console.log("  Already logged into an account!");
        }
      }
      
      _signInUsingFacebook() {
        console.log("ProfileView._signInUsingFacebook");

        if(this.user == null) {
          console.log("  signInWithPopup");
          this.$.auth.provider = "facebook";
          return this.$.auth.signInWithPopup();
        } else {
          console.log("  Already logged into an account!");
        }
      }

      _signInUsingTwitter() {
        console.log("ProfileView._signInUsingTwitter");

        if(this.user == null) {
          console.log("  signInWithPopup");
          this.$.auth.provider = "twitter";
          return this.$.auth.signInWithPopup();
        } else {
          console.log("  Already logged into an account!");
        }
      }

      _signOut() {
          console.log("ProfileView._logout");

          return this.$.auth.signOut();
      }
    }

    window.customElements.define(ProfileView.is, ProfileView);
  </script>
</dom-module>
