<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="utility.html">

<!--<link rel="import" href="../bower_components/app-media/app-media-devices.html">
<link rel="import" href="../bower_components/app-media/app-media-stream.html">
<link rel="import" href="../bower_components/app-media/app-media-video.html">
<link rel="import" href="../bower_components/app-media/app-media-audio.html">
<link rel="import" href="../bower_components/app-media/app-media-waveform.html">
<link rel="import" href="../bower_components/app-media/app-media-recorder.html">
<link rel="import" href="../bower_components/app-media/app-media-image-capture.html">-->

<!--<link rel="import" href="webrtc-adaptor.html">-->

<link rel="import" href="shared-styles.html">

<dom-module id="cameratest-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
    </style>

  <firebase-auth 
    id="auth"
    app-name="polyn-app"
    user="{{user}}">
  </firebase-auth>

  <div class="card">
    <h1>Pick Image</h1>
    <input type="file" accept="image/*" capture="camera" id="camera">
    <img id="frame">
  </div>

  <!--<div class="card">
    <h1>Take Picture</h1>
    <button id="capture">Capture</button>
    <video id="player" width=320 height=240 controls autoplay></video>
    <canvas id="snapshot" width=320 height=240></canvas>
  </div>-->

  <div class="card">
    <h1>Test Toast</h1>
    <paper-button on-tap="_onTapTestToast" raised>Test Toast</paper-button>
  </div>

  </template>

  <script>

    class CameraTestView extends Polymer.Element {

      static get is() { return 'cameratest-view'; }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: '_userChanged'
          }
        };
      }

      // constructor() {
      //     super()
      //     console.log("CameraTestView.constructor")
      // }

      // ready() {
      //     super.ready();

      //     console.log("CameraTestView.ready")

      //     // When possible, use afterNextRender to defer non-critical
      //     // work until after first paint.
      //     Polymer.RenderStatus.afterNextRender(this, function() {
      //         console.log("CameraTestView.afterNextRender")
      //     });
      // }

      _userChanged(user) {
        console.log("CameraTestView._userChanged");
        //console.log("  user: " + JSON.stringify(user, null, 4));

        // As soon as we get the user - get the users info so we can 
        // learn more about them!
        if(user && user.uid) {
          //this.$.usersinfo.path = "/users/" + user.uid + "/info";
        }
      }

      _onTapTestToast() {
 
        Utility.showErrorToast("This is a test toast!");
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("CameraTestView.connectedCallback")

        //https://developers.google.com/web/fundamentals/native-hardware/capturing-images/

        //
        // Get a pic from the user!
        //
        // Works in both Chrome and Safari.
        //

        var camera = this.$.camera;
        var frame = this.$.frame;

        var self = this;

        camera.addEventListener('change', function(e) {

          var file = e.target.files[0];

          if(!file) {
            return;
          }

          if(!file.type.match('image.*')) {
            Utility.showErrorToast("You can only share images");
            return;
          }

          // Do something with the image file.
          frame.src = URL.createObjectURL(file);

          // //Upload the image to Cloud Storage.
          // var newImageKey = firebase.app("polyn-app").database().ref().child("users/" + self.user.uid).push().key;
          // firebase.app("polyn-app").storage().ref("users/" + self.user.uid + "/" + newImageKey).put(file).then(function(snapshot) {

          // Upload the image to Cloud Storage.
          firebase.app("polyn-app").storage().ref("users/" + self.user.uid + "/pic").put(file).then(function(snapshot) {
            // Get the file's storage URI and save into the database under the user's info key.
            var fullPath = snapshot.metadata.fullPath;
            firebase.app("polyn-app").database().ref().child("/users/" + self.user.uid + "/info/pic").set(fullPath);
          });
        });


        //
        // Get video and play it back!
        //                            
        // Works only in Chrome.
        //

        // var player = this.$.player;

        // var handleSuccess = function(stream) {
        //   player.srcObject = stream;
        // };

        // navigator.mediaDevices.getUserMedia({video: true})
        //   .then(handleSuccess);



        //
        // Get video and play it back but allow a pic to be captured!
        //
        // Works only in Chrome.
        //

        // var player = this.$.player; 
        // var snapshotCanvas = this.$.snapshot;
        // var captureButton = this.$.capture;
        // var videoTracks;

        // var handleSuccess = function(stream) {
        //   // Attach the video stream to the video element and autoplay.
        //   player.srcObject = stream;
        //   videoTracks = stream.getVideoTracks();
        // };

        // captureButton.addEventListener('click', function() {

        //   var context = snapshotCanvas.getContext('2d');

        //   // Draw the video frame to the canvas.
        //   context.drawImage(player, 0, 0, snapshotCanvas.width, snapshotCanvas.height);

        //   // Stop all video streams.
        //   //videoTracks.forEach(function(track) {track.stop()});
        // });

        // navigator.mediaDevices.getUserMedia({video: true})
        //   .then(handleSuccess);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
          console.log("CameraTestView.disconnectedCallback")
      }

      attributeChangedCallback() {
          console.log("CameraTestView.attributeChangedCallback")
      }
    }

    window.customElements.define(CameraTestView.is, CameraTestView);

  </script>
</dom-module>
