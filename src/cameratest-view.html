<link rel="import" href="../bower_components/polymer/polymer-element.html">

<!--<link rel="import" href="../bower_components/app-media/app-media-devices.html">
<link rel="import" href="../bower_components/app-media/app-media-stream.html">
<link rel="import" href="../bower_components/app-media/app-media-video.html">
<link rel="import" href="../bower_components/app-media/app-media-audio.html">
<link rel="import" href="../bower_components/app-media/app-media-waveform.html">
<link rel="import" href="../bower_components/app-media/app-media-recorder.html">
<link rel="import" href="../bower_components/app-media/app-media-image-capture.html">-->

<!--<link rel="import" href="webrtc-adaptor.html">-->

<link rel="import" href="shared-styles.html">

<dom-module id="cameratest-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

    </style>

    <!--<app-media-devices
      kind="videoinput"
      selected-device="{{videoDevice}}">
    </app-media-devices>-->

    <!--<app-media-image-capture
        id="imageCapture"
        stream="[[videoStream]]"
        focus-mode="single-shot"
        red-eye-reduction
        last-photo="{{photo}}">
    </app-media-image-capture>-->

  <div class="card">
    <h1>Pick Image</h1>
    <input type="file" accept="image/*" capture="camera" id="camera">
    <img id="frame">
  </div>

  <div class="card">
    <h1>Take Picture</h1>
    <button id="capture">Capture</button>
    <video id="player" width=320 height=240 controls autoplay></video>
    <canvas id="snapshot" width=320 height=240></canvas>
  </div>

  </template>

  <script>

    class CameraTestView extends Polymer.Element {

      static get is() { return 'cameratest-view'; }

      // static get properties() {
      //   return {
      //     }
      //   };
      // }

      constructor() {
          super()
          console.log("CameraTestView.constructor")
      }

      ready() {
          super.ready();

          console.log("CameraTestView.ready")

          // When possible, use afterNextRender to defer non-critical
          // work until after first paint.
          Polymer.RenderStatus.afterNextRender(this, function() {
              console.log("CameraTestView.afterNextRender")
          });
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("CameraTestView.connectedCallback")

        //https://developers.google.com/web/fundamentals/native-hardware/capturing-images/

        //
        // Get a pic from the user!
        //
        // Works in both Chrome and Safari.
        //

        var camera = this.$.camera;
        var frame = this.$.frame;

        camera.addEventListener('change', function(e) {
          var file = e.target.files[0]; 
          // Do something with the image file.
          frame.src = URL.createObjectURL(file);
        });



        //
        // Get video and play it back!
        //                            
        // Works only in Chrome.
        //

        // var player = this.$.player;

        // var handleSuccess = function(stream) {
        //   player.srcObject = stream;
        // };

        // navigator.mediaDevices.getUserMedia({video: true})
        //   .then(handleSuccess);



        //
        // Get video and play it back but allow a pic to be captured!
        //
        // Works only in Chrome.
        //

        var player = this.$.player; 
        var snapshotCanvas = this.$.snapshot;
        var captureButton = this.$.capture;
        var videoTracks;

        var handleSuccess = function(stream) {
          // Attach the video stream to the video element and autoplay.
          player.srcObject = stream;
          videoTracks = stream.getVideoTracks();
        };

        captureButton.addEventListener('click', function() {

          var context = snapshotCanvas.getContext('2d');

          // Draw the video frame to the canvas.
          context.drawImage(player, 0, 0, snapshotCanvas.width, snapshotCanvas.height);

          // Stop all video streams.
          //videoTracks.forEach(function(track) {track.stop()});
        });

        navigator.mediaDevices.getUserMedia({video: true})
          .then(handleSuccess);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
          console.log("CameraTestView.disconnectedCallback")
      }

      attributeChangedCallback() {
          console.log("CameraTestView.attributeChangedCallback")
      }
    }

    window.customElements.define(CameraTestView.is, CameraTestView);

  </script>
</dom-module>
