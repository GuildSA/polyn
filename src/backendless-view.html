
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../src/redux-store.html">

<dom-module id="backendless-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
    </style>

    <div class="card">
      <h1>Backendless Data Test</h1>

        <paper-button on-tap="_onTapCreateData" raised>Create Data</paper-button>
        <paper-button on-tap="_onTapGetData" raised>Get Data</paper-button>

        <dom-repeat items="[[testTable]]" as="testTableEntry">
            <template>
                <div class="card">
                    <p>[[testTableEntry.data]]</p>
                </div>
            </template>
        </dom-repeat>

    </div>

    <div class="card">
        <h1>Backendless Login Test</h1>

        <paper-input id="email" label="Email"></paper-input>
        <paper-input id="password" label="Password"></paper-input>
        <paper-button on-tap="_onTapRegister" raised>Register</paper-button>
        <paper-button on-tap="_onTapLogin" raised>Login</paper-button>
        <paper-button on-tap="_onTapLogout" raised>Logout</paper-button>
    </div>

    <div class="card">
        <h1>Redux</h1>
        <paper-button on-tap="_onTapTestReduxThunk" raised>Test Thunk</paper-button>
    </div>

    <paper-dialog id="errorDialog">
      <h2>Error</h2>
      <p id="errorMessage"></p>
      <div class="buttons">
        <paper-button dialog-confirm autofocus>OK</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    class BackendlessView extends ReduxMixin(AsyncActionsMixin(Polymer.Element)) {
        
        static get is() { return 'backendless-view'; }

        static get properties() {
            return {
                searchText: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true,
                    observer: '_searchTextChanged'
                },
// Redux simple test...
                currentSearchText: {
                  type: String,
                  statePath: 'currentSearchText',
                  computed: 'computeCurrentSearchText(currentSearchText)'
                },
                friends: {
                  type: Array,
                  statePath: 'friends'
                },
                friendCount: {
                  type: Number,
                  computed: 'computeFriendCount(friends)'
                },
// Redux Thunk test...
                loading: {
                    type: Boolean,
                    statePath: 'loading'
                },
                username: {
                    type: String,
                    statePath: 'username',
                    observer: '_usernameChanged'
                }

            };
        }

        ready() {
            super.ready();
            console.log("BackendlessView.ready");

            this.testTable = [];
        }


// Redux simple test...
        computeCurrentSearchText(text) {
            console.log("BackendlessView.computeCurrentSearchText: text = " + text);
// TODO: How can we stop listening to this when the view is not shown?
            return text;
        }

// Redux simple test...
        computeFriendCount(friends) {
            console.log("BackendlessView.computeFriendCount: friends = " + friends);
            return friends.length;
        }
// Redux Thunk test...
        _onTapTestReduxThunk() {
            console.log("BackendlessView._onTapTestReduxThunk");
            const username = "Kevin";
            this.dispatch('signUpWithTimeout', username);
        }
// Redux Thunk test...
        _usernameChanged() {
            console.log("BackendlessView._usernameChanged: " + this.username);

            if(this.username != null) {
                alert("Redux Thunk sent back: " + this.username);
            }
        }

// // TODO: Should we replace this with Redux?
        _searchTextChanged() {
            console.log("BackendlessView._searchTextChanged: " + this.searchText);

            // The search text changed - get the data!
            this._onTapGetData();
        }

        _addTestTableEntry(testTableEntry) {
            console.log("BackendlessView._addTestTableEntry: " + testTableEntry.objectId);

            this.push('testTable', testTableEntry);
        }

        _onTapRegister() {
            console.log("BackendlessView._onTapRegister");

            var self = this;

            console.log("  email: " + this.$.email.value);
            console.log("  password: " + this.$.password.value);

            function userRegistered(user) {
                console.log(  "User has been registered!");
            }

            function gotError(err) {
                console.log("  error message - " + err.message);
                console.log("  error code - " + err.statusCode);

                self.$.errorMessage.innerHTML = error.message;
                self.$.errorDialog.toggle();
            }

            var user = new Backendless.User();
            user.email = this.$.email.value;
            user.password = this.$.password.value;

            Backendless.UserService.register( user ).then( userRegistered ).catch( gotError );
        }

        _onTapLogin() {
            console.log("BackendlessView._onTapLogin");

            var self = this;

            console.log("  email: " + this.$.email.value);
            console.log("  password: " + this.$.password.value);

            Backendless.UserService.login(this.$.email.value, this.$.password.value, true)
            .then(function(loggedInUser) {
                console.log("  User has logged in!");
            })
            .catch(function(error) {
                console.log("  error message: " + error.message);
                console.log("  error code: " + error.statusCode);

                self.$.errorMessage.innerHTML = error.message
                self.$.errorDialog.toggle();
            });
        }

        _onTapLogout() {
            console.log("BackendlessView._onTapLogout");

            var self = this;

            Backendless.UserService.logout()
            .then(function() {
                console.log( "  User has logged out!" );
            })
            .catch(function(error) {

                console.log( "  error message: " + error.message );
                console.log( "  error code: " + error.statusCode );

                self.$.errorMessage.innerHTML = error.message;
                self.$.errorDialog.toggle();
            });
        }

        _onTapCreateData() {
            console.log("BackendlessView._onTapCreateData");

            var self = this;

            Backendless.Data.of("TestTable").save( { data:"Some Test Data: " + Math.random()} )
            .then(function(obj) {
                console.log("  object saved. objectId " + obj.objectId)
                self.addTestTableEntry(obj)
            } )
            .catch(function(error) {
                console.log("  error message: " + error.message);
                console.log("  error code: " + error.statusCode);

                self.$.errorMessage.innerHTML = error.message;
                self.$.errorDialog.toggle();
            });
        }

        _onTapGetData() {
            console.log("BackendlessView._onTapGetData");

            var self = this;

            var queryBuilder = Backendless.DataQueryBuilder.create();

            if(this.searchText) {
                queryBuilder.setWhereClause("data LIKE '%" + this.searchText + "%'");
            }

            Backendless.Data.of("TestTable").find(queryBuilder)
            .then(function(result) {

                self.testTable = [];

                console.log("  Loaded " + result.length + " objects!");

                for(var i = 0; i < result.length; i++) {
                    //console.log("  objectId = " + result[i].objectId);
                    self._addTestTableEntry(result[i])
                }

            })
            .catch(function(error) {

                console.log("  error message: " + error.message);
                console.log("  error code: " + error.statusCode);

                self.$.errorMessage.innerHTML = error.message;
                self.$.errorDialog.toggle();
            });
        }

    }

    window.customElements.define(BackendlessView.is, BackendlessView);

  </script>
</dom-module>
