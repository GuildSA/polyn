
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="custom-icons.html">
<link rel="import" href="geofire.html">

<dom-module id="home-view">
  <template>
    <style include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: block;
        padding: 0px;
      }

      /*.business-description {
        margin: 0%;
      }*/

      /*.business-image {
        width: 75px;
        height: 75px;
        border-radius: 50%;
      }*/

      h2 {
        color: #70C187;
      }

      /*.item {
        transition-timing-function: ease-out;
        transition-duration: .75s;
        background: #eee;
        width: 100%;
      }

      .item:hover {
        opacity: .75;
      }*/

      /*.main-container {
        display: flex;
        align-items: center;
        width: 100%;
        @apply --layout-wrap;
        @apply --layout-center;
        @apply --layout-around-justified;
      }*/

      /*paper-fab {
        --paper-fab-background: var(--app-secondary-color);
        bottom: 2.5%;
        right: 2.5%;
        position: fixed;
      }*/

      /*.profile-pic {
        border-radius: 5%;
        display: flex;
        @apply --layout-vertical;
      }*/

      /*.stick-btn-container {
        justify-content: center;
        right:0;
        left:0;
      }*/

      #submit-request-container {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-around-justified;
        color: white;
        background: #70C187;
        border-radius: 5px;
        max-width: 400px;
        margin: auto;
        position: sticky;
        position: -webkit-sticky;
        bottom: 0px;
      }
    </style>

    <app-indexeddb-mirror
      key="sellers"
      data="{{sellers}}"
      persisted-data="{{persistedSellers}}">
    </app-indexeddb-mirror>

    <dom-repeat items="[[persistedSellers]]" as="seller" initial-count="2">
      <template>

        <div class="card layout vertical" on-tap="_onTapBusiness">
          <iron-image style="width:100%; height:400px; background-color: lightgray;" sizing="cover" preload fade src="[[seller.photoUrl]]"></iron-image>
          <center><h2>[[seller.name]]</h2></center>

          <template is="dom-if" if="[[seller.distance]]">
            <center><h1>[[seller.distance]] miles away</h1></center>
          </template>

          <p>[[seller.desc]]</p>
        </div>

      </template>
    </dom-repeat>

    <div id="submit-request-container">
      <paper-button class="sticky-btn" on-tap="_onTapCreateRequest" icon="custom-icons:message" >Create a Request</paper-button>
    </div>

  </template>

  <script>
    class HomeView extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'home-view'; }

      static get properties() {
        return {
          location: {
            type: Array,
            value: null
          },
          sellers: {
            type: Array,
            value: []
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("HomeView.connectedCallback");

        //this._loadSellersNoLocation("collectables/sub/vinylRecords");
        this._loadSellersByLocation("collectables/sub/vinylRecords", 100);
      }

      _loadSellersNoLocation(sellersCategory) {
        console.log("HomeView._loadSellersNoLocation: " + sellersCategory);

        var self = this;

        var setSeller = function(snapshot) {

          var childKey = snapshot.key;

          const refPath = "/sellers/" + childKey;
          firebase.app("polyn-app").database().ref(refPath).once('value').then(function(snapshot) {

            var sellersInfo = snapshot.val();

            if(sellersInfo) {

              self.push('sellers', sellersInfo);

              // Since we don't know anything about the user's location - sort alphabetically by name.
              self.sellers.sort(function(a, b){
                if(a.name < b.name) return -1;
                if(a.name > b.name) return 1;
                return 0;
              })

            } else {
              console.log("  Failed to get data for seller key: " + key);
            }
          });
        };

        firebase.app("polyn-app").database().ref("/locations/" + sellersCategory).on('child_added', setSeller);
      }

      _loadSellersByLocation(sellersCategory, rangeInMiles) {
        console.log("HomeView._loadSellersByLocation: " + rangeInMiles);

        var self = this;

        // Geofire only uses KM.
        const rangeInKm = 1.6 * parseFloat(rangeInMiles);

        if(!this.location) {

          // If we don't know the user's current location - ask for it!

          //GeofireManager.getUsersLocation("users/" + this.user.uid + "/info", 
          GeofireManager.getUsersLocation(null, // Pass null for user's info path since we don't actually need a user to do this.

            function(location) {
              var latitude = location.coords.latitude;
              var longitude = location.coords.longitude;

              // Cache the user's location.
              self.location = [latitude, longitude];

              console.log("User Location is lat: " + latitude + ", long: " + longitude + "");

              self._getSellerData(sellersCategory, latitude, longitude, rangeInKm);
            },
            
            function(error) {
              console.log("User Location error: " + error + "");
              // We have no location to use - just get the sellers direclty from the selected category!
              self._loadSellersNoLocation(sellersCategory);
          });

        } else {

          // If we DO know the user's current location - just get the sellers!
          self._getSellerData(sellersCategory, this.location[0], this.location[1], rangeInKm);
        }
      }

      _getSellerData(sellersCategory, latitude, longitude, rangeInKm) {
        console.log("HomeView._getSellerData");

        var self = this;

        this.sellers = [];

        // Find all the sellers within a circle defined by a 
        // lat/long for the center of a circle and a range in kilometers.
        // The lat/long should come from the user's current location.
        GeofireManager.getSellersByLocation(sellersCategory, latitude, longitude, rangeInKm,
          function(key, distance) {

            console.log("  GeofireView got seller key: " + key);
            console.log("  distance =  " + distance + " miles away");

            const refPath = "/sellers/" + key;
            firebase.app("polyn-app").database().ref(refPath).once('value').then(function(snapshot) {

              var sellersInfo = snapshot.val();

              if(sellersInfo) {

                var roundedDistance = parseFloat(distance).toFixed(1);
                sellersInfo.distance = roundedDistance;

                self.push('sellers', sellersInfo);

                // Sort by distance - closet location at top.
                self.sellers.sort(function(a, b){return a.distance - b.distance});

              } else {
                console.log("  Failed to get data for seller key: " + key);
              }
            });
        });
      }

      _onTapBusiness(e) {
        console.log("HomeView._onTapBusiness: " + e);

        var polynApp = document.getElementById("polynApp");
        var businessView = polynApp.pushPageOnCurrentTab("business-view");

        const index = e.model.index;
        businessView.sellerInfo = this.sellers[index];
      }
      
      _onTapCreateRequest() {
        console.log("HomeView._onTapCreateRequest");
        var polynApp = document.getElementById("polynApp");
        var requestView = polynApp.pushPageOnCurrentTab("request-view");
      }
    }

    window.customElements.define(HomeView.is, HomeView);
  </script>
</dom-module>
