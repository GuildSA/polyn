
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/px-spinner/px-spinner.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="custom-icons.html">
<link rel="import" href="geofire.html">

<dom-module id="home-view">
  <template>
    <style include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: block;
        padding: 0px;
      }

      .top-border {
        border-top-style: solid;
        border-top-color: var(--app-accent-color);
        border-top-width: .5px;
        margin-top: 15px;
        padding-top: 10px;
      }

      .business-img {
        width: 150px;
        height: 150px;
        border-radius: 2.5%;
        border-color: var(--app-accent-color);
      }

      h2 {
        color: #70C187;
        margin: 0;
        display: flex;
        justify-content: center;
      }

      .main-container {
        display: flex;
        align-items: center;
        width: 100%;
        @apply --layout-vertical;
        @apply --layout-center;
        @apply --layout-around-justified;
      }

      .seller-name {
         border-bottom: var(--app-accent-color);
      } 

      #submit-request-container {
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-around-justified;
        color: white;
        background: #70C187;
        border-radius: 5px;
        width: 100%;
        max-width: 400px;
        margin: auto;
        position: sticky;
        position: -webkit-sticky;
        bottom: 0px;
      }

      .business-img {
        width: 100%;
      }

      .card {
        @apply --layout-vertical;
      }

      @media (max-width: 767px) {

        .top-border {
          
          @apply --layout-vertical;
          @apply --layout-justified;
          border-top-style: none;
          border-top-color: none;
          border-top-width: 0px;
          margin-top: 0px;
          padding-top: 0px;
        }

        .business-img {
          display: flex;
          height: 10vh;
          width: 10vh;
          border-radius: 0%;
        }

        .card {
          width: 95%;
          @apply --layout-horizontal;
          @apply --layout-start-justified;
          padding: 0;
          margin: 0.5rem;
        }

        .short-description {
          display: none;
        }

        h1 {
          color: grey;
          margin: 0;
          padding: 10px;
        }

        h2 {
          font-size: 1rem;
          margin-left: 25px;
          margin-top: 10px;
          color: black;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .miles-away {
          font-size: 0.5 rem;
          margin-left: 25px;
        }

        #location {
          --paper-input-container-focus-color: #70C187;
        }

        paper-input {
          margin: 0;
          padding: 0;
        }

      }
    </style>

    <firebase-auth 
      id="auth"
      app-name="polyn-app"
      user="{{user}}">
    </firebase-auth>

    <firebase-document
      app-name="polyn-app"
      id="usersinfo"
      data="{{usersInfo}}">
    </firebase-document>

    <app-indexeddb-mirror
      key="sellers"
      data="{{sellers}}"
      persisted-data="{{persistedSellers}}">
    </app-indexeddb-mirror>

    <div class="main-container">

      <!-- Mobile Device Media Query -->
      <iron-media-query query="(min-width:300px) and (max-width: 767px)" query-matches="{{mobileDevice}}"></iron-media-query>
        <template is="dom-if" if="{{mobileDevice}}">
          <h1>Record Stores In Your Area</h1>
           <div class="layout horizontal center-justified" id="location">
            <paper-input id="zip" type="number" maxlength="5">
            <!--<paper-input id="zip" label="Enter your zip code" allowed-pattern="[0-9]" pattern="[0-9]">-->
              <paper-icon-button icon="custom-icons:near-me" slot="prefix"></paper-icon-button>
            </paper-input>
          </div>
        </template>    
    </div>
    <!-- / Mobile Device Media Query -->

      <dom-repeat items="[[persistedSellers]]" as="seller" initial-count="2">
      
        <template>
          <div class="card" on-tap="_onTapBusiness">
            <iron-image class="business-img" style="background-color: lightgray;" sizing="cover" preload fade src="[[seller.photoUrl]]"></iron-image>
            <div class="top-border">
                <h2>[[seller.name]]</h2>
            <template is="dom-if" if="[[seller.distance]]">
              <div class="miles-away">
                [[seller.distance]] miles away
              </div>
            </div>
            </template>
             <div class="short-description">
                <p>[[seller.desc]]</p>
             </div>
          </div>
        </template>

      </dom-repeat>

      <div id="submit-request-container">
        <paper-button id="sticky-btn" on-tap="_onTapCreateRequest" icon="custom-icons:message" >Create a Request</paper-button>
      </div>
    </div>

    <template is="dom-if" if="[[loading]]">
      <div class="overlay">
        <px-spinner size="100" finished="[[!loading]]"></px-spinner>
      </div>
    </template>

  </template>

  <script>
    class HomeView extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'home-view'; }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: '_userChanged'
          },
          usersInfo: {
            type: Object,
            observer: '_usersInfoChanged'
          },
          location: {
            type: Array,
            value: null
          },
          sellers: {
            type: Array,
            value: []
          },
          sellersCategory: {
            type: String,
            value: "collectables/sub/vinylRecords",
            readOnly: true
          },
          loading: {
            type: Boolean,
            notify: true,
            value: true
          }
        };
      }

      reload() {
        console.log("HomeView.reload");

        //this._loadSellersNoLocation();
        this._loadSellersByLocation(100);
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("HomeView.connectedCallback");

        //this._loadSellersNoLocation();
        this._loadSellersByLocation(100);

        //
        // Convert a Zip Code into a Lat/Long...
        //

// TODO: Make use of the lat/long based on zip code when the user rejects location.

        //var googleMapsApi = this.$.googleMapsApi;
        var polynApp = document.getElementById("polynApp");
        var googleMapsApi = polynApp.$.googleMapsApi;

        //googleMapsApi.addEventListener('api-load', function(e) {

          var geocoder = new googleMapsApi.api.Geocoder();
          
          //const address = "Plano, TX";
          const address = "75025";
          geocoder.geocode( {'address': address}, function(results, status) {
            //console.log(" status: " + status);
            //console.log(" esults: " + JSON.stringify(results, null, 4));
            if(status == google.maps.GeocoderStatus.OK) {
              const lat = results[0].geometry.location.lat();
              const long = results[0].geometry.location.lng();
              console.log("  The address: " + address + ", was converted into:");
              console.log("    Lat: " + lat + ", Long: " + long);
            } else {
              console.log("  Geocode was not successful for the following reason: " + status);
            }
          });
        //});
      }

      _userChanged(user) {
        console.log("HomeView._userChanged");
        //console.log("HomeView._userChanged: " + JSON.stringify(user, null, 4));

        // As soon as we get the user - get the users info so we can 
        // learn more about them!
        if(user && user.uid) {
          this.$.usersinfo.path = "/users/" + user.uid + "/info";
        }
      }

      _usersInfoChanged(usersInfo) {
        console.log("ChatView._usersInfoChanged");
        //console.log("HomeView._usersInfoChanged: " + JSON.stringify(usersInfo, null, 4));

        if(!usersInfo || Object.keys(usersInfo).length === 0 && usersInfo.constructor === Object) {
          return;
        }

        if(!usersInfo.location) {

          const self = this;

          GeofireManager.getUsersLocation("users/" + this.user.uid + "/info",

            function(location) {
              const latitude = location.coords.latitude;
              const longitude = location.coords.longitude;
              // Cache the user's location.
              self.location = [latitude, longitude];

//const rangeInKm = 1.6 * parseFloat(rangeInMiles);
//self._getSellerData(this.location[0], this.location[1], rangeInKm);
            },
            
            function(error) {
              console.log("User Location error: " + error + "");
          });
        }
      }

      _loadSellersNoLocation() {
        console.log("HomeView._loadSellersNoLocation");

        const self = this;

        this.sellers = [];

        firebase.app("polyn-app").database().ref("/locations/" + this.sellersCategory).on('child_added', function(snapshot) {

          const childKey = snapshot.key;

          firebase.app("polyn-app").database().ref("/sellers/" + childKey).once('value').then(function(snapshot) {

            var sellersInfo = snapshot.val();

            if(sellersInfo) {

              sellersInfo.key = snapshot.key; // Cache the key so we can look up the lat/long later.

              self.push('sellers', sellersInfo);

              // Since we don't know anything about the user's location - sort alphabetically by name.
              self.sellers.sort(function(a, b){
                if(a.name < b.name) return -1;
                if(a.name > b.name) return 1;
                return 0;
              })

              self.loading = false;

            } else {
              console.log("  Failed to get data for seller key: " + key);
              self.loading = false;
            }
          });
        })
      }

      _loadSellersByLocation(rangeInMiles) {
        console.log("HomeView._loadSellersByLocation: " + rangeInMiles);

        const self = this;
        this.loading = true;

        // Geofire only uses KM.
        const rangeInKm = 1.6 * parseFloat(rangeInMiles);

        if(!this.location) {

          // If we don't know the user's current location - ask for it!

          //GeofireManager.getUsersLocation("users/" + this.user.uid + "/info", 
          GeofireManager.getUsersLocation(null, // Pass null for user's info path since we don't actually need a user to do this.

            function(location) {
              const latitude = location.coords.latitude;
              const longitude = location.coords.longitude;

              // Cache the user's location.
              self.location = [latitude, longitude];

              //console.log("User Location is lat: " + latitude + ", long: " + longitude + "");

              self._getSellerData(latitude, longitude, rangeInKm);
            },
            
            function(error) {
              console.log("User Location error: " + error + "");
              // We have no location to use - just get the sellers direclty from the selected category!
              self._loadSellersNoLocation();
          });

        } else {

          // If we already know the user's current location - just get the sellers!
          self._getSellerData(this.location[0], this.location[1], rangeInKm);
        }
      }

      _getSellerData(latitude, longitude, rangeInKm) {
        console.log("HomeView._getSellerData");

        const self = this;

        this.sellers = [];

        // Find all the sellers within a circle defined by a 
        // lat/long for the center of a circle and a range in kilometers.
        // The lat/long should come from the user's current location.
        GeofireManager.getSellersByLocation(this.sellersCategory, latitude, longitude, rangeInKm,
          function(key, distance) {

            //console.log("  got seller key: " + key);
            //console.log("  distance =  " + distance + " miles away");

            firebase.app("polyn-app").database().ref("/sellers/" + key).once('value').then(function(snapshot) {

              var sellersInfo = snapshot.val();

              if(sellersInfo) {

                sellersInfo.key = snapshot.key; // Cache the key so we can look up the lat/long later.

                var roundedDistance = parseFloat(distance).toFixed(1);
                sellersInfo.distance = roundedDistance; // Cache the distance for the UI.

                self.push('sellers', sellersInfo);

                // Sort by distance - closet location at top.
                self.sellers.sort(function(a, b){return a.distance - b.distance});

// TODO: We need a way to know how many in total will get pulled down.
                self.loading = false;

              } else {
                console.log("  Failed to get data for seller key: " + key);
                self.loading = false;
              }
            });
        });
      }

      _onTapBusiness(e) {
        console.log("HomeView._onTapBusiness: " + e);

        var polynApp = document.getElementById("polynApp");
        var businessView = polynApp.pushPageOnCurrentTab("business-view");

        const index = e.model.index;
        businessView.sellerInfo = this.sellers[index];
      }
      
      _onTapCreateRequest() {
        console.log("HomeView._onTapCreateRequest");

        var polynApp = document.getElementById("polynApp");
        var requestView = polynApp.pushPageOnCurrentTab("request-view");
      }
    }

    window.customElements.define(HomeView.is, HomeView);
  </script>
</dom-module>
