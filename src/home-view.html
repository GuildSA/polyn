
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../bower_components/iron-iconset-svg/iron-iconset-svg.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-behavior.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="custom-icons.html">

<dom-module id="home-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 0px;
      }

      .item {
        transition-timing-function: ease-out;
        transition-duration: .75s;
        background: #eee;
        width: 100%;
      }


      .item:hover {
        opacity: .75;
      }

      .main-container {
        display: flex;
        align-items: center;
        width: 100%;
        @apply --layout-wrap;
        @apply --layout-center;
        @apply --layout-around-justified;
      }

      paper-fab {
        --paper-fab-background: var(--app-secondary-color);
        bottom: 2.5%;
        right: 2.5%;
        position: fixed;
      }

      .profile-pic {
        
        border-radius: 5%;
        display: flex;
        @apply --layout-vertical;
      }

      .business-description {
        margin: 0%;
        
      }

      h2 {
        color: #70C187;
      }

    </style>

    <firebase-auth 
      id="auth"
      app-name="polyn-app"
      user="{{user}}">
    </firebase-auth>

    <firebase-document
      app-name="polyn-app"
      id="usersinfo"
      data="{{usersInfo}}">
    </firebase-document>

    <paper-spinner id="spinner" active="[[loading]]" active></paper-spinner>

    <!-- TODO: We can use a dom-repeat for these business-cards -->
    <div class="main-container">
      <div class="card">
        <div class="business-image item">
          <iron-image style="height:25vh; background-color: lightgray;" sizing="cover" class="profile-pic" preload fade src="images/RecordStoreDayLogo.jpg" class="item" on-tap="_onTapBusiness" ></iron-image>
        </div>
        <div class="business-description">
         <h2> Good Records</h2>
          <p>Description Goes Here</p>
          <p><paper-icon-button icon="custom-icons:near-me"></paper-icon-button>1.2 miles away</p> 
          <p><paper-icon-button icon="custom-icons:phonelink-ring"></paper-icon-button>(214) 752-4663</p>
          <p><paper-icon-button icon="custom-icons:web"></paper-icon-button>www.goodrecords.com</p>
        </div>
      </div>
    <div class="card">
        <div class="business-image item">
          <iron-image style="height:25vh; background-color: lightgray;" sizing="cover" class="profile-pic" preload fade src="images/RecordStoreDayLogo.jpg" class="item" on-tap="_onTapBusiness" ></iron-image>
        </div>
        <div class="business-description">
          <h2> Spinster Records</h2>
          <p><paper-icon-button icon="custom-icons:near-me"></paper-icon-button>2.3 miles away</p> 
          <p><paper-icon-button icon="custom-icons:phonelink-ring"></paper-icon-button>(214) 752-4663</p>
          <p><paper-icon-button icon="custom-icons:web"></paper-icon-button>www.goodrecords.com</p>
        </div>
      </div>
    <div class="card">
        <div class="business-image">
          <iron-image style="height:25vh; background-color: lightgray;" sizing="cover" class="profile-pic" preload fade src="images/RecordStoreDayLogo.jpg" class="item" on-tap="_onTapBusiness" ></iron-image>
        </div>
        <div class="business-description">
          <h2>Bills Records</h2>
          <p><paper-icon-button icon="custom-icons:near-me"></paper-icon-button>3.6 miles away</p> 
          <p><paper-icon-button icon="custom-icons:phonelink-ring"></paper-icon-button>(214) 752-4663</p>
          <p><paper-icon-button icon="custom-icons:web"></paper-icon-button>www.goodrecords.com</p>
        </div>
      </div>
      <div class="card">
      <div class="business-image">
        <iron-image style="height:25vh; background-color: lightgray;" sizing="cover" class="profile-pic" preload fade src="images/RecordStoreDayLogo.jpg" class="item" on-tap="_onTapBusiness" ></iron-image>
      </div>
      <div class="business-description">
        <h2> Hit Records</h2>
          <p><paper-icon-button icon="custom-icons:near-me"></paper-icon-button>4.0 miles away</p> 
          <p><paper-icon-button icon="custom-icons:phonelink-ring"></paper-icon-button>(214) 752-4663</p>
          <p><paper-icon-button icon="custom-icons:web"></paper-icon-button>www.goodrecords.com</p>
      </div>
    </div>
  </div>

    <paper-fab id="fab" icon="custom-icons:message" on-tap="_onTapCreateMessage"></paper-fab>

    <iron-ajax
      id="sendRequet"
      url="https://us-central1-polyn-3c431.cloudfunctions.net/sendRequest"
      method="POST"
      loading="{{loading}}"
      on-response="_handleSendRequestResponse"
      on-error="_handleSendRequestError"
      debounce-duration="300">
    </iron-ajax>

    <paper-dialog id="requestDialog">
      <p>What is your request?</p>
      <paper-input label="Short Description..." value="{{titleDialogValue}}"></paper-input>
      <paper-input label="Long Description..." value="{{bodyDialogValue}}"></paper-input>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="_onTapRequestDialogBtn" dialog-confirm autofocus>Request</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    class HomeView extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'home-view'; }

      static get properties() {
        return {
          loading: {
            type: Boolean,
            notify: true,
            value: false
          },
          titleDialogValue: {
            type: String,
            value: ""
          },
          bodyDialogValue: {
            type: String,
            value: ""
          },
          user: {
            type: Object,
            observer: '_userChanged'
          },
          usersInfo: {
            type: Object
          }
        };
      }

      _userChanged(user) {
        console.log("HomeView._userChanged");

        // As soon as we get the user - get the users info so we can 
        // learn more about them!
        if(user && user.uid) {
          this.$.usersinfo.path = "/users/" + user.uid + "/info";
        }
      }

      _onTapBusiness() {
        var polynApp = document.getElementById("polynApp");
        var businessView = polynApp.pushPageOnCurrentTab("business-view");
        businessView.businessId = 1;
      }
      
      _onClickItem() {
        var polynApp = document.getElementById("polynApp");
        var itemView = polynApp.pushPageOnCurrentTab("item-view");
        itemView.itemId = 2;
      }

      _onTapCreateMessage() {
        console.log("HomeView._onTapCreateMessage");

        this.$.requestDialog.toggle();
      }

      _onTapRequestDialogBtn() {
        console.log("HomeView._onTapRequestDialogBtn: " + this.titleDialogValue);

        if(!this.user || !this.usersInfo) {
          return;
        }
        
        const requestKey = firebase.app("polyn-app").database().ref('/users/' + this.user.uid + '/chats').push().key;

        // Add the user's new request to their 'chats' key as a reference.
        let newRequest = {
          subject: this.titleDialogValue,
          body: this.bodyDialogValue,
          buyerId: this.user.uid,
          buyer: this.usersInfo.name,
          timeStamp: firebase.database.ServerValue.TIMESTAMP
        };

        firebase.app("polyn-app").database().ref('/users/' + this.user.uid + '/chats/' + requestKey).set(newRequest).then(snapshot => {

          // Send this info to the server.
          var params = {
            categoryPath: "collectables/sub/vinylRecords",
            title: this.titleDialogValue,
            body: this.bodyDialogValue,
            buyerId: this.user.uid,
            buyer: this.usersInfo.name,
            requestId: requestKey
          };

          this.$.sendRequet.params = params;
          this.$.sendRequet.generateRequest(); // Calls: sendRequest()

        });
      }

      _handleSendRequestResponse(data) {
        console.log("HomeView._handleSendRequestResponse");
        console.log("  status = " + data.detail.status);
      }

      _handleSendRequestError(e) {
        console.log("HomeView._handleSendRequestError");
        console.log("  status = ", e.status, e.statusText);
      }
    }

    window.customElements.define(HomeView.is, HomeView);
  </script>
</dom-module>
