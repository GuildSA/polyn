<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-input/iron-input.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="utility.html">
<link rel="import" href="cropper.html">

<dom-module id="misctest-view">

  <template>
    <style include="shared-styles cropper-styles">
      :host {
        display: block;
        padding: 10px;
      }

      #originalImage {
        max-width: 100%;
      }

      iron-image {
        --iron-image-width: 100%;
      }

      google-map {
        height: 300px;
      }

    </style>

    <firebase-auth 
      id="auth"
      app-name="polyn-app"
      user="{{user}}">
    </firebase-auth>

    <div class="card">
      <paper-button on-tap="_onTapTestToast" raised>Test Toast</paper-button>
    </div>

    <div class="card">
      <paper-button on-tap="_onTapPickImage" raised="">Pick Image</paper-button>
      <input id="camera" type="file" name="photo" accept="image/*;capture=camera" style="display:none;"></input>
      <div>
        <img id="originalImage">
      </div>
      <paper-button on-tap="_onTapCropImage" raised="">Crop Image</paper-button>
    </div>

    <div class="card">
      <iron-image id="croppedImage" alt="Cropped Image Results"></iron-image>
    </div>

  </template>

  <script>

    class MiscTestView extends Polymer.Element {

      static get is() { return 'misctest-view'; }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: '_userChanged'
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        console.log("MiscTestView.connectedCallback");

        //
        // Get a pic from the user and allow it to be cropped!
        //
        // Works in both Chrome and Safari.
        //

        var camera = this.$.camera;
        var frame = this.$.frame;

        var self = this;

        camera.addEventListener('change', function(e) {

          var file = e.target.files[0];

          if(!file) {
            return;
          }

          if(!file.type.match('image.*')) {
            Utility.showErrorToast("You can only share images");
            return;
          }

          self.$.originalImage.src = URL.createObjectURL(file);

          self.cropper = new Cropper(self.$.originalImage, {
            aspectRatio: 1,
            crop: function(e) {
              console.log(e.detail.x);
              console.log(e.detail.y);
              console.log(e.detail.width);
              console.log(e.detail.height);
              console.log(e.detail.rotate);
              console.log(e.detail.scaleX);
              console.log(e.detail.scaleY);
            }
          });
        });
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        console.log("MiscTestView.disconnectedCallback");
      }

      attributeChangedCallback() {
        console.log("MiscTestView.attributeChangedCallback");
      }

      _userChanged(user) {
        console.log("MiscTestView._userChanged");
        //console.log("  user: " + JSON.stringify(user, null, 4));
      }

      _onTapTestToast() {
        console.log("MiscTestView._onTapTestToast");
        Utility.showErrorToast("This is a test toast!");
      }

      _onTapPickImage() {
        console.log("MiscTestView._onTapPickImage");
        this.$.camera.click();
      }

      _onTapCropImage() {
        console.log("MiscTestView._onTapCropImage:");

        if(this.cropper) {

          var self = this;

          this.cropper.getCroppedCanvas().toBlob(function(blob) {

            self.$.croppedImage.src = URL.createObjectURL(blob);

            // Upload the image to Cloud Storage.
            var newImageKey = firebase.app("polyn-app").database().ref().child("tests").push().key;

            firebase.app("polyn-app").storage().ref("tests/" + newImageKey).put(blob).then(function(snapshot) {
              console.log("snapshot.downloadURL = " + snapshot.downloadURL);
            });

          });
        }
      }
    }

    window.customElements.define(MiscTestView.is, MiscTestView);

  </script>
</dom-module>
